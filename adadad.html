<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†è€…å¾Œå° | å¥åº·å¤¥ä¼´ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --tbp-blue: #8699a3;
            --bg-color: #f4f7f9;
            --card-bg: #ffffff;
            --text-dark: #333;
            --danger: #ff8c73;
        }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: var(--text-dark); }
        .hidden { display: none !important; }
        .admin-container { max-width: 1100px; margin: 20px auto; background: var(--card-bg); padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--tbp-blue); padding-bottom: 15px; margin-bottom: 20px; }
        h1 { color: var(--tbp-blue); margin: 0; font-size: 1.5rem; }
        .btn-group { display: flex; gap: 10px; }
        button { padding: 10px 18px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .primary-btn { background: var(--tbp-blue); color: white; }
        .outline-btn { background: #eee; color: #666; }
        .danger-btn { background: var(--danger); color: white; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .modal-card { background: white; padding: 25px; border-radius: 10px; width: 100%; max-width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8f9fa; color: #666; text-align: left; padding: 12px; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .status-tag { font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; background: #eee; color: #888; }
        .active-tag { background: #e6f0f9; color: #5a7d9a; }
        #upload-status { margin-top: 10px; padding: 10px; border-radius: 4px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="admin-login-overlay" class="modal-overlay" style="background: #e2ddd4; z-index:3000;">
        <div class="modal-card" style="text-align: center;">
            <h2 style="color: var(--tbp-blue);">ç®¡ç†è€…ç™»å…¥</h2>
            <input type="password" id="admin-password-input" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼">
            <button class="primary-btn" style="width: 100%;" onclick="checkAdminAuth()">ç™»å…¥å¾Œå°</button>
        </div>
    </div>

    <div id="add-user-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <h3>æ–°å¢ä½¿ç”¨è€…åºè™Ÿ</h3>
            <input type="text" id="new-serial" placeholder="è¼¸å…¥æ–°åºè™Ÿ (å¦‚: BA001)">
            <input type="text" id="new-password" placeholder="é è¨­å¯†ç¢¼">
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="outline-btn" style="flex:1" onclick="closeAddModal()">å–æ¶ˆ</button>
                <button class="primary-btn" style="flex:1" onclick="confirmAddUser()">ç¢ºèªæ–°å¢</button>
            </div>
        </div>
    </div>

    <div id="main-admin-content" class="admin-container hidden">
        <header>
            <h1>å¥åº·å¤¥ä¼´ç®¡ç†ç³»çµ±</h1>
            <div class="btn-group">
                <button class="primary-btn" onclick="openAddModal()">ï¼‹ æ–°å¢ä½¿ç”¨è€…</button>
                <button class="danger-btn" onclick="location.reload()">ç™»å‡º</button>
            </div>
        </header>

        <div style="margin-bottom: 20px; padding: 20px; border: 2px dashed #ccc; border-radius: 8px; background: #fff;">
            <label style="font-weight: bold; display: block; margin-bottom: 10px;">ğŸ“Š ä¸Šå‚³å¥åº·æ•¸æ“š Excel (è‡ªå‹•è¾¨è­˜åˆ†é åºè™Ÿ)ï¼š</label>
            <input type="file" id="excel-upload" accept=".xlsx, .xls">
            <button class="primary-btn" onclick="handleExcelUpload()">é–‹å§‹åŒ¯å…¥æ•¸æ“š</button>
            <div id="upload-status"></div>
        </div>

        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>åºè™Ÿ</th>
                        <th>å¯†ç¢¼</th>
                        <th>æš±ç¨±</th>
                        <th>å¤¥ä¼´åå­—</th>
                        <th>å»ºç«‹æ™‚é–“</th>
                    </tr>
                </thead>
                <tbody id="user-list">
                    <tr><td colspan="5" style="text-align:center;">è¼‰å…¥ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://gcvwebgfbrsrezxvjafe.supabase.co";
        const SUPABASE_KEY = "sb_publishable_H_-X-v5cU7I3IHjml2CGUQ_FUK6teZs";
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const ADMIN_PW = "888tBPC!!";

        function checkAdminAuth() {
            if (document.getElementById('admin-password-input').value === ADMIN_PW) {
                document.getElementById('admin-login-overlay').classList.add('hidden');
                document.getElementById('main-admin-content').classList.remove('hidden');
                loadUsers();
            } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
        }

        function openAddModal() { document.getElementById('add-user-modal').classList.remove('hidden'); }
        function closeAddModal() { document.getElementById('add-user-modal').classList.add('hidden'); }

        async function confirmAddUser() {
            const serial = document.getElementById('new-serial').value.trim();
            const pw = document.getElementById('new-password').value.trim();
            if (!serial || !pw) return alert("è«‹å¡«å¯«å®Œæ•´");
            const { error } = await _supabase.from('user_credentials').insert([{ serial_number: serial, password: pw }]);
            if (error) alert("éŒ¯èª¤: " + error.message);
            else { alert("æ–°å¢æˆåŠŸ"); closeAddModal(); loadUsers(); }
        }

        // --- æ ¸å¿ƒï¼šExcel è™•ç†é‚è¼¯ ---
        async function handleExcelUpload() {
            const fileInput = document.getElementById('excel-upload');
            const status = document.getElementById('upload-status');
            if (!fileInput.files[0]) return alert("è«‹é¸æ“‡æª”æ¡ˆ");

            status.style.color = "#666";
            status.innerHTML = "â³ æ­£åœ¨è™•ç† Excel æª”æ¡ˆ...";

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    // è¨­å®š cellDates: true è®“ SheetJS å˜—è©¦è‡ªå‹•è½‰æ›æ—¥æœŸæ ¼å¼
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    
                    const { data: users } = await _supabase.from('user_credentials').select('serial_number');
                    const validSerials = users.map(u => u.serial_number);

                    let allData = [];
                    for (const sheetName of workbook.SheetNames) {
                        if (validSerials.includes(sheetName)) {
                            const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                            sheetData.forEach(row => {
                                let rawDate = row.record_start;
                                let formattedDate = null;

                                if (rawDate) {
                                    // è™•ç† Excel åºåˆ—æ•¸å­—å ±éŒ¯å•é¡Œ
                                    if (rawDate instanceof Date) {
                                        formattedDate = rawDate.toISOString().split('T')[0];
                                    } else if (typeof rawDate === 'number') {
                                        // å°‡ Excel æ•¸å­—è½‰æ›ç‚º JS Date
                                        const dateObj = XLSX.SSF.parse_date_code(rawDate);
                                        formattedDate = `${dateObj.y}-${String(dateObj.m).padStart(2, '0')}-${String(dateObj.d).padStart(2, '0')}`;
                                    } else {
                                        // è™•ç†å­—ä¸²æ ¼å¼
                                        formattedDate = String(rawDate).split(' ')[0].replace(/\//g, '-');
                                    }
                                }

                                if (formattedDate && formattedDate !== "undefined") {
                                    allData.push({
                                        serial_number: sheetName,
                                        record_date: formattedDate,
                                        raw_json: row
                                    });
                                }
                            });
                        }
                    }

                    if (allData.length === 0) throw new Error("æ‰¾ä¸åˆ°åŒ¹é…çš„åºè™Ÿåˆ†é æˆ–æ—¥æœŸæ ¼å¼éŒ¯èª¤");

                    status.innerHTML = `ğŸš€ æ­£åœ¨åŒæ­¥ ${allData.length} ç­†è³‡æ–™åˆ°é›²ç«¯...`;
                    
                    // æ‰¹æ¬¡å¯«å…¥
                    const chunkSize = 100;
                    for (let i = 0; i < allData.length; i += chunkSize) {
                        const chunk = allData.slice(i, i + chunkSize);
                        const { error } = await _supabase.from('health_data').upsert(chunk, { onConflict: 'serial_number, record_date' });
                        if (error) throw error;
                    }

                    status.style.color = "green";
                    status.innerHTML = `âœ… æˆåŠŸåŒ¯å…¥ï¼å…±æ›´æ–° ${allData.length} ç­†æ•¸æ“šã€‚`;
                    
                } catch (err) {
                    status.style.color = "red";
                    status.innerHTML = "âŒ åŒ¯å…¥å¤±æ•—: " + err.message;
                }
            };
            reader.readAsArrayBuffer(fileInput.files[0]);
        }

        async function loadUsers() {
            const { data } = await _supabase.from('user_credentials').select('*').order('created_at', { ascending: false });
            const tbody = document.getElementById('user-list');
            tbody.innerHTML = "";
            data.forEach(user => {
                tbody.innerHTML += `<tr>
                    <td><strong>${user.serial_number}</strong></td>
                    <td>${user.password}</td>
                    <td>${user.nickname || '--'}</td>
                    <td>${user.ai_name || '--'}</td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                </tr>`;
            });
        }
    </script>
</body>
</html>

