<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†è€…å¾Œå° | å¥åº·å¤¥ä¼´ç®¡ç†ç³»çµ±04</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --tbp-blue: #8699a3; --bg-color: #f4f7f9; --card-bg: #ffffff; --text-dark: #333; --danger: #ff8c73; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: var(--text-dark); }
        .hidden { display: none !important; }
        .admin-container { max-width: 1100px; margin: 20px auto; background: var(--card-bg); padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--tbp-blue); padding-bottom: 15px; margin-bottom: 20px; }
        h1 { color: var(--tbp-blue); margin: 0; font-size: 1.5rem; }
        .btn-group { display: flex; gap: 10px; }
        button { padding: 10px 18px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .primary-btn { background: var(--tbp-blue); color: white; }
        .outline-btn { background: #eee; color: #666; }
        .danger-btn { background: var(--danger); color: white; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .modal-card { background: white; padding: 25px; border-radius: 10px; width: 100%; max-width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8f9fa; color: #666; text-align: left; padding: 12px; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .upload-section { margin-bottom: 20px; padding: 20px; border: 2px dashed #ddd; border-radius: 8px; background: #fcfcfc; }
        .status-msg { margin-top: 10px; font-size: 0.85rem; min-height: 1.2em; }
    </style>
</head>
<body>

    <div id="admin-login-overlay" class="modal-overlay" style="background: #f4f7f9; z-index:3000;">
        <div class="modal-card" style="text-align: center;">
            <h2 style="color: var(--tbp-blue);">ç®¡ç†è€…ç™»å…¥</h2>
            <input type="password" id="admin-password-input" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼">
            <button class="primary-btn" style="width: 100%;" onclick="checkAdminAuth()">ç™»å…¥å¾Œå°</button>
        </div>
    </div>

    <div id="add-user-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <h3>æ–°å¢ä½¿ç”¨è€…åºè™Ÿ</h3>
            <input type="text" id="new-serial" placeholder="è¼¸å…¥æ–°åºè™Ÿ (å¦‚: BA001)">
            <input type="text" id="new-password" placeholder="é è¨­å¯†ç¢¼">
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="outline-btn" style="flex:1" onclick="closeAddModal()">å–æ¶ˆ</button>
                <button class="primary-btn" style="flex:1" onclick="confirmAddUser()">ç¢ºèªæ–°å¢</button>
            </div>
        </div>
    </div>

    <div id="main-admin-content" class="admin-container hidden">
        <header>
            <h1>å¥åº·å¤¥ä¼´ç®¡ç†ç³»çµ±</h1>
            <div class="btn-group">
                <button class="primary-btn" onclick="openAddModal()">ï¼‹ æ–°å¢ä½¿ç”¨è€…</button>
                <button class="danger-btn" onclick="adminLogout()">ç™»å‡º</button>
            </div>
        </header>

        <div class="upload-section" style="border-color: var(--tbp-blue);">
            <h3 style="margin-top:0;">ğŸ“Š 1. ç©¿æˆ´è£ç½®åŸå§‹æ•¸æ“š (è®€å– record_end)</h3>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="file" id="excel-upload-raw" accept=".xlsx, .xls" style="width: auto;">
                <button class="primary-btn" onclick="handleRawDataUpload()">åŒ¯å…¥åŸå§‹æ•¸æ“š</button>
            </div>
            <div id="raw-status" class="status-msg"></div>
        </div>

        <div class="upload-section" style="border-color: #5a7d9a;">
            <h3 style="margin-top:0;">ğŸ“ 2. å¥åº·æ‘˜è¦è³‡æ–™ä¾†æº (è®€å– Excel ä¸­çš„ã€Œæ—¥æœŸã€)</h3>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="file" id="excel-upload-feedback" accept=".xlsx, .xls" style="width: auto;">
                <button class="primary-btn" style="background:#5a7d9a" onclick="handleFeedbackUpload()">åŒ¯å…¥ç‡ˆè™Ÿèˆ‡å›é¥‹</button>
            </div>
            <div id="feedback-status" class="status-msg"></div>
        </div>

        <table>
            <thead>
                <tr><th>åºè™Ÿ (åˆ†é å)</th><th>å¯†ç¢¼</th><th>æš±ç¨±</th><th>å¤¥ä¼´åå­—</th><th>æ“ä½œ</th></tr>
            </thead>
            <tbody id="user-list"></tbody>
        </table>
    </div>

    <script>
        const SUPABASE_URL = "https://gcvwebgfbrsrezxvjafe.supabase.co";
        const SUPABASE_KEY = "sb_publishable_H_-X-v5cU7I3IHjml2CGUQ_FUK6teZs";
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const ADMIN_PW = "888tBPC!!";

        // ç®¡ç†è€…åŸºç¤é‚è¼¯
        function checkAdminAuth() {
            if (document.getElementById('admin-password-input').value === ADMIN_PW) {
                document.getElementById('admin-login-overlay').classList.add('hidden');
                document.getElementById('main-admin-content').classList.remove('hidden');
                loadUsers();
            } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
        }
        function adminLogout() { location.reload(); }
        function openAddModal() { document.getElementById('add-user-modal').classList.remove('hidden'); }
        function closeAddModal() { document.getElementById('add-user-modal').classList.add('hidden'); }

        async function loadUsers() {
            const { data } = await _supabase.from('user_credentials').select('*').order('created_at', { ascending: false });
            const tbody = document.getElementById('user-list');
            tbody.innerHTML = data.map(u => `
                <tr>
                    <td><strong>${u.serial_number}</strong></td>
                    <td><code>${u.password}</code></td>
                    <td>${u.nickname || '--'}</td>
                    <td>${u.ai_name || '--'}</td>
                    <td><button class="outline-btn" style="padding:4px 8px; font-size:0.8rem;" onclick="alert('åºè™Ÿï¼š${u.serial_number}')">æŸ¥çœ‹</button></td>
                </tr>
            `).join('');
        }

        async function confirmAddUser() {
            const serial = document.getElementById('new-serial').value.trim();
            const pw = document.getElementById('new-password').value.trim();
            if (!serial || !pw) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");
            await _supabase.from('user_credentials').insert([{ serial_number: serial, password: pw }]);
            closeAddModal(); loadUsers();
        }

        // --- åŠŸèƒ½ 1ï¼šè™•ç†ç©¿æˆ´æ•¸æ“š (record_end) ---
        async function handleRawDataUpload() {
            await processExcel('excel-upload-raw', 'raw-status', 'health_data', (row, sheetName) => {
                let d = formatDate(row.record_end);
                return d ? { serial_number: sheetName, record_date: d, raw_json: row } : null;
            });
        }

        // --- åŠŸèƒ½ 2ï¼šè™•ç†ç‡ˆè™Ÿå›é¥‹ (æå–ã€Œæ—¥æœŸã€) ---
        async function handleFeedbackUpload() {
            await processExcel('excel-upload-feedback', 'feedback-status', 'daily_feedback', (row, sheetName) => {
                let d = formatDate(row['æ—¥æœŸ']); // ç²¾æº–æå–ã€Œæ—¥æœŸã€æ¬„ä½
                if (!d) return null;

                return {
                    serial_number: sheetName,
                    record_date: d,
                    status_light: row['ç”Ÿç†ç‹€æ…‹ç‡ˆè™Ÿ'] || null,
                    self_score: String(row['è‡ªè©•é›»é‡'] || ''),
                    feedback: row['åé¥‹'] || null,
                    raw_json: row
                };
            });
        }

        // é€šç”¨ Excel è™•ç†å¼•æ“
        async function processExcel(inputId, statusId, tableName, mapperFn) {
            const fileInput = document.getElementById(inputId);
            const status = document.getElementById(statusId);
            if (!fileInput.files[0]) return alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆ");

            status.style.color = "#666";
            status.innerHTML = "â³ æ­£åœ¨è®€å–åˆ†é ä¸¦æ¯”å°åºè™Ÿ...";

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    
                    // ç²å–æœ‰æ•ˆåºè™Ÿ
                    const { data: users } = await _supabase.from('user_credentials').select('serial_number');
                    const validSerials = users.map(u => u.serial_number);

                    const finalData = [];
                    let matchedSheets = [];

                    workbook.SheetNames.forEach(sheetName => {
                        if (validSerials.includes(sheetName)) {
                            matchedSheets.push(sheetName);
                            const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                            sheetData.forEach(row => {
                                const mapped = mapperFn(row, sheetName);
                                if (mapped) finalData.push(mapped);
                            });
                        }
                    });

                    if (finalData.length === 0) throw new Error("æ‰¾ä¸åˆ°åŒ¹é…çš„åˆ†é åç¨±æˆ–æ—¥æœŸè³‡æ–™ã€‚");

                    status.innerHTML = `ğŸš€ å·²è­˜åˆ¥åˆ†é : ${matchedSheets.join(', ')}<br>ä¸Šå‚³ä¸­: ${finalData.length} ç­†è³‡æ–™...`;

                    // æ‰¹æ¬¡å¯«å…¥
                    const chunkSize = 100;
                    for (let i = 0; i < finalData.length; i += chunkSize) {
                        const { error } = await _supabase.from(tableName).upsert(finalData.slice(i, i + chunkSize), { onConflict: 'serial_number, record_date' });
                        if (error) throw error;
                    }

                    status.style.color = "green";
                    status.innerHTML = `âœ… æˆåŠŸï¼å·²æ›´æ–° ${matchedSheets.length} å€‹åºè™Ÿåˆ†é ï¼Œå…± ${finalData.length} ç­†è³‡æ–™ã€‚`;
                } catch (err) {
                    status.style.color = "red";
                    status.innerHTML = "âŒ éŒ¯èª¤: " + err.message;
                }
            };
            reader.readAsArrayBuffer(fileInput.files[0]);
        }

        // è¬ç”¨æ—¥æœŸæ ¼å¼åŒ– (æ”¯æ´ Date ç‰©ä»¶, Excel åºè™Ÿ, å­—ä¸²)
        function formatDate(raw) {
            if (!raw || raw === "undefined") return null;
            try {
                if (raw instanceof Date) return raw.toISOString().split('T')[0];
                if (typeof raw === 'number') {
                    const d = XLSX.SSF.parse_date_code(raw);
                    return `${d.y}-${String(d.m).padStart(2,'0')}-${String(d.d).padStart(2,'0')}`;
                }
                // è™•ç† 2025/12/11 æ ¼å¼
                let str = String(raw).trim().split(' ')[0].replace(/\//g, '-');
                if (str.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
                    const parts = str.split('-');
                    return `${parts[0]}-${parts[1].padStart(2,'0')}-${parts[2].padStart(2,'0')}`;
                }
                return null;
            } catch (e) { return null; }
        }
    </script>
</body>
</html>


