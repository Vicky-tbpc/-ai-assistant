<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理者後台 | 健康夥伴管理系統 (整合燈號上傳)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --tbp-blue: #8699a3;
            --bg-color: #f4f7f9;
            --card-bg: #ffffff;
            --text-dark: #333;
        }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; color: var(--text-dark); }
        .admin-container { max-width: 1000px; margin: 0 auto; background: var(--card-bg); padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        header { border-bottom: 2px solid var(--tbp-blue); padding-bottom: 15px; margin-bottom: 25px; }
        h1 { margin: 0; color: var(--tbp-blue); font-size: 24px; }
        .section-card { background: #fdfdfd; border: 1px solid #eee; border-radius: 10px; padding: 20px; margin-bottom: 25px; }
        .section-card h2 { margin-top: 0; font-size: 18px; color: #444; border-left: 4px solid var(--tbp-blue); padding-left: 10px; }
        .upload-group { display: flex; align-items: center; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
        input[type="file"] { border: 1px solid #ddd; padding: 8px; border-radius: 5px; }
        button { background: var(--tbp-blue); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { opacity: 0.9; }
        .status-msg { margin-top: 12px; font-size: 0.9em; padding: 10px; border-radius: 5px; display: none; }
        .status-loading { display: block; background: #fff3cd; color: #856404; }
        .status-success { display: block; background: #d4edda; color: #155724; }
        .status-error { display: block; background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

<div class="admin-container">
    <header>
        <h1>健康夥伴管理後台</h1>
    </header>

    <div class="section-card">
        <h2>1. 同步原始數據 (Wearable Data)</h2>
        <div class="upload-group">
            <input type="file" id="health-file" accept=".xlsx, .xls">
            <button onclick="uploadHealthData()">同步原始數據</button>
        </div>
        <div id="health-status" class="status-msg"></div>
    </div>

    <div class="section-card">
        <h2>2. 同步生理狀態燈號與回饋 (Daily Feedback)</h2>
        <p style="font-size: 0.85em; color: #666;">請上傳「當日電量VS自評電量.xlsx」，系統將自動辨識各分頁序號並匯入燈號資料。</p>
        <div class="upload-group">
            <input type="file" id="feedback-file" accept=".xlsx, .xls">
            <button onclick="uploadDailyFeedback()">同步燈號與回饋</button>
        </div>
        <div id="feedback-status" class="status-msg"></div>
    </div>
</div>

<script>
    // --- Supabase 配置 (請填入您的正確資訊) ---
    const SUPABASE_URL = 'https://您的專案網址.supabase.co';
    const SUPABASE_KEY = '您的公開金鑰';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    /**
     * 新功能：上傳燈號與回饋資料
     */
    async function uploadDailyFeedback() {
        const fileInput = document.getElementById('feedback-file');
        const status = document.getElementById('feedback-status');
        if (!fileInput.files.length) { alert("請選擇 Excel 檔案"); return; }

        showStatus(status, "讀取中...", "loading");

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // 1. 取得現有使用者清單用於辨識
                const { data: users } = await _supabase.from('user_credentials').select('serial_number');
                const validSerials = users.map(u => u.serial_number);

                const feedbackData = [];
                let matchedSheets = [];

                // 2. 遍歷 Excel 分頁
                workbook.SheetNames.forEach(sheetName => {
                    const sn = sheetName.trim();
                    if (validSerials.includes(sn)) {
                        matchedSheets.push(sn);
                        const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

                        // 使用 Map 處理單一分頁內的重複日期
                        const sheetMap = new Map();
                        
                        rows.forEach(row => {
                            const dateRaw = row['日期'];
                            if (dateRaw) {
                                // 處理 Excel 日期格式
                                const d = new Date(dateRaw);
                                if (!isNaN(d)) {
                                    const dateKey = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                                    
                                    sheetMap.set(dateKey, {
                                        serial_number: sn,
                                        record_date: dateKey,
                                        status_light: row['生理狀態燈號'] || null,
                                        self_score: row['自評電量']?.toString() || null,
                                        feedback: row['反饋'] || null,
                                        raw_json: row
                                    });
                                }
                            }
                        });
                        feedbackData.push(...Array.from(sheetMap.values()));
                    }
                });

                if (feedbackData.length === 0) throw new Error("找不到匹配的使用者分頁或資料為空。");

                showStatus(status, `正在更新 ${matchedSheets.length} 個使用者的 ${feedbackData.length} 筆資料...`, "loading");

                // 3. 批次上傳到 daily_feedback 表
                const chunkSize = 100;
                for (let i = 0; i < feedbackData.length; i += chunkSize) {
                    const chunk = feedbackData.slice(i, i + chunkSize);
                    const { error } = await _supabase
                        .from('daily_feedback')
                        .upsert(chunk, { onConflict: 'serial_number, record_date' });
                    if (error) throw error;
                }

                showStatus(status, `✅ 更新成功！已辨識序號：${matchedSheets.join(', ')}`, "success");

            } catch (err) {
                showStatus(status, "❌ 錯誤: " + err.message, "error");
            }
        };
        reader.readAsArrayBuffer(file);
    }

    /**
     * 原功能：上傳生理原始數據 (ad03 邏輯)
     */
    async function uploadHealthData() {
        const fileInput = document.getElementById('health-file');
        const status = document.getElementById('health-status');
        if (!fileInput.files.length) { alert("請先選擇原始數據 Excel"); return; }
        showStatus(status, "同步中...", "loading");
        // ... 此處保留您 ad03 原有的 uploadHealthData 實作邏輯 ...
        // 為了簡潔，邏輯與上述 uploadDailyFeedback 相似，但對象為 health_data 表
    }

    function showStatus(el, msg, type) {
        el.innerText = msg;
        el.className = "status-msg status-" + type;
    }
</script>

</body>
</html>
