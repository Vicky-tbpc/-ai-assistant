<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†è€…å¾Œå° | å¥åº·å¤¥ä¼´ç®¡ç†ç³»çµ± ad05æ•´åˆç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --tbp-blue: #8699a3; --bg-color: #f4f7f9; --card-bg: #ffffff; --text-dark: #333; --danger: #ff8c73; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: var(--text-dark); }
        .hidden { display: none !important; }
        .admin-container { max-width: 1100px; margin: 20px auto; background: var(--card-bg); padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--tbp-blue); padding-bottom: 15px; margin-bottom: 25px; }
        h1 { margin: 0; color: var(--tbp-blue); font-size: 24px; }
        
        .section-card { background: #fdfdfd; border: 1px solid #eee; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .section-card h2 { margin-top: 0; font-size: 18px; color: #555; border-left: 4px solid var(--tbp-blue); padding-left: 10px; }
        
        .upload-group { display: flex; align-items: center; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
        input[type="file"] { border: 1px solid #ddd; padding: 8px; border-radius: 5px; background: white; }
        
        button { background: var(--tbp-blue); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; transition: 0.3s; }
        button:hover { background: #6f818a; }
        button.secondary { background: #eee; color: #555; }
        
        .status-msg { margin-top: 10px; font-size: 0.9em; min-height: 1.2em; }
        .loading { color: orange; font-weight: bold; }
    </style>
</head>
<body>

<div class="admin-container">
    <header>
        <h1>ç®¡ç†è€…å¾Œå°ç³»çµ±</h1>
        <button class="secondary" onclick="location.reload()">é‡æ–°æ•´ç†</button>
    </header>

    <div class="section-card">
        <h2>1. ç©¿æˆ´è£ç½®åŸå§‹æ•¸æ“š (å¥åº·æ•¸æ“šåŒæ­¥)</h2>
        <p style="font-size: 0.85em; color: #888;">è«‹ä¸Šå‚³åŒ…å«ä»¥ã€Œåºè™Ÿã€å‘½åçš„åˆ†é  Excelã€‚ç³»çµ±æœƒæ ¹æ“š record_end è‡ªå‹•å»é‡ä¸¦æ›´æ–°æ•¸æ“šã€‚</p>
        <div class="upload-group">
            <input type="file" id="health-file" accept=".xlsx, .xls">
            <button onclick="uploadHealthData()">é–‹å§‹åŒæ­¥å¥åº·æ•¸æ“š</button>
        </div>
        <div id="health-status" class="status-msg"></div>
    </div>

    <div class="section-card">
        <h2>2. å»ºè­°è©å¥åº«æ›´æ–°</h2>
        <p style="font-size: 0.85em; color: #888;">è«‹ä¸Šå‚³åŒ…å« battery, Daily_Tag, best, worst, attention, goal, button ç­‰åˆ†é çš„ Excelã€‚</p>
        <div class="upload-group">
            <input type="file" id="phrase-file" accept=".xlsx, .xls">
            <button onclick="uploadPhraseLibrary()">æ›´æ–°å»ºè­°è©å¥åº«</button>
        </div>
        <div id="phrase-status" class="status-msg"></div>
    </div>

</div>

<script>
    // --- è«‹æ›¿æ›æ‚¨çš„ Supabase é‡‘é‘° ---
    const SUPABASE_URL = 'https://æ‚¨çš„å°ˆæ¡ˆç¶²å€.supabase.co';
    const SUPABASE_KEY = 'æ‚¨çš„å…¬é–‹é‡‘é‘°';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    /**
     * åŠŸèƒ½ 1: ç©¿æˆ´è£ç½®æ•¸æ“šä¸Šå‚³ (æ ¸å¿ƒé‚è¼¯åƒç…§ ad03)
     */
    async function uploadHealthData() {
        const fileInput = document.getElementById('health-file');
        const status = document.getElementById('health-status');

        if (!fileInput.files.length) {
            alert("è«‹å…ˆé¸æ“‡ Excel æª”æ¡ˆ");
            return;
        }

        status.innerHTML = "æ­£åœ¨è§£ææª”æ¡ˆä¸¦æª¢æŸ¥åºè™Ÿ...";
        status.className = "status-msg loading";

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // 1. ç²å–åˆæ³•ä½¿ç”¨è€…æ¸…å–®
                const { data: users, error: userError } = await _supabase.from('user_credentials').select('serial_number');
                if (userError) throw userError;
                const validSerials = users.map(u => u.serial_number);

                const dataMap = new Map(); // ç”¨æ–¼å»é‡ (Key: åºè™Ÿ_æ—¥æœŸ)
                let matchedSheets = [];

                // 2. éæ­·åˆ†é ï¼Œé‚è¼¯æ”¹ç‚ºè®€å– record_end
                workbook.SheetNames.forEach(sheetName => {
                    if (validSerials.includes(sheetName)) {
                        matchedSheets.push(sheetName);
                        const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

                        sheetData.forEach(row => {
                            // è®€å– record_end ä½œç‚ºåŸºæº–æ—¥æœŸ
                            const endVal = row['record_end'];
                            if (endVal) {
                                let rawDate = new Date(endVal);

                                if (!isNaN(rawDate)) {
                                    const formattedDate = `${rawDate.getFullYear()}-${String(rawDate.getMonth() + 1).padStart(2, '0')}-${String(rawDate.getDate()).padStart(2, '0')}`;
                                    
                                    // ad03 çš„é—œéµå»é‡é‚è¼¯ï¼šåŒä¸€å¤©åªç•™æœ€å¾Œä¸€ç­†
                                    const key = `${sheetName}_${formattedDate}`;
                                    dataMap.set(key, {
                                        serial_number: sheetName,
                                        record_date: formattedDate,
                                        raw_json: row
                                    });
                                }
                            }
                        });
                    }
                });

                const allData = Array.from(dataMap.values());
                if (allData.length === 0) throw new Error("æ‰¾ä¸åˆ°åŒ¹é…çš„åºè™Ÿåˆ†é æˆ–æ—¥æœŸæ ¼å¼ä¸æ­£ç¢ºã€‚");

                status.innerHTML = `ğŸš€ å·²è¾¨è­˜ ${matchedSheets.length} å€‹åºè™Ÿåˆ†é ï¼Œæº–å‚™ä¸Šå‚³ ${allData.length} ç­†è³‡æ–™...`;

                // 3. æ‰¹æ¬¡å¯«å…¥ (Upsert)
                const chunkSize = 100;
                for (let i = 0; i < allData.length; i += chunkSize) {
                    const chunk = allData.slice(i, i + chunkSize);
                    const { error } = await _supabase
                        .from('health_data')
                        .upsert(chunk, { onConflict: 'serial_number, record_date' });
                    
                    if (error) throw error;
                }

                status.style.color = "green";
                status.className = "status-msg";
                status.innerHTML = `âœ… æˆåŠŸï¼å·²æ›´æ–° ${matchedSheets.length} å€‹åˆ†é ï¼Œå…± ${allData.length} ç­†æ•¸æ“šã€‚`;

            } catch (err) {
                status.style.color = "red";
                status.className = "status-msg";
                status.innerHTML = "âŒ å¤±æ•—: " + err.message;
                console.error(err);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    /**
     * åŠŸèƒ½ 2: è©å¥åº«æ›´æ–° (ad05 åŸæœ‰åŠŸèƒ½)
     */
    async function uploadPhraseLibrary() {
        const fileInput = document.getElementById('phrase-file');
        const status = document.getElementById('phrase-status');

        if (!fileInput.files.length) {
            alert("è«‹é¸æ“‡è©å¥åº« Excel æª”æ¡ˆ");
            return;
        }

        status.innerHTML = "æ­£åœ¨è™•ç†è©å¥åº«...";
        status.className = "status-msg loading";

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                let allPhrases = [];

                workbook.SheetNames.forEach(sheetName => {
                    const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                    rows.forEach(row => {
                        let entry = { category: sheetName };
                        
                        if (sheetName === 'battery') {
                            entry.logic_key = `${row.TST_min}${row.N3_pct}${row.rMSSD}${row.HR_min}${row.HBI}`;
                            entry.detailed_content = row['è©³ç´°è§£èªª'];
                            entry.simple_content = row['ä¸€å¥å¤§çœ¾æ˜“æ‡‚åˆå¼·èª¿å¥åº·åƒ¹å€¼çš„ç‰ˆæœ¬'];
                            entry.title = row['é‡é»æ‘˜è¦'];
                        } 
                        else if (sheetName === 'Daily_Tag') {
                            entry.title = row['Daily_Tag'];
                            entry.simple_content = row['å»ºè­°'];
                            entry.detailed_content = row['__EMPTY'] || row['å…§å®¹']; // ä¾ Excel æ¬„ä½åç¨±èª¿æ•´
                        }
                        else if (sheetName === 'button') {
                            entry.title = row['é¸é …å•å¥'];
                            entry.detailed_content = row['å…§å®¹'];
                            entry.action_suggest = row['å‹•ä½œ'];
                        }
                        else if (['best', 'worst', 'attention', 'goal'].includes(sheetName)) {
                            entry.logic_key = row['å‚™è¨»'];
                            entry.detailed_content = row['æ³¨æ„'] || row['é”æ¨™'] || row['é‡é»æ‘˜è¦'];
                            entry.action_suggest = row['å»ºè­°'];
                        }

                        if (entry.detailed_content || entry.title) {
                            allPhrases.push(entry);
                        }
                    });
                });

                // æ¸…ç†èˆŠè³‡æ–™ä¸¦åŒ¯å…¥æ–°è³‡æ–™
                await _supabase.from('phrase_library').delete().neq('category', 'keep_this');
                const { error } = await _supabase.from('phrase_library').insert(allPhrases);
                if (error) throw error;

                status.style.color = "green";
                status.className = "status-msg";
                status.innerHTML = `âœ… è©å¥åº«æ›´æ–°å®Œæˆï¼å…±åŒ¯å…¥ ${allPhrases.length} ç­†è³‡æ–™ã€‚`;

            } catch (err) {
                status.style.color = "red";
                status.className = "status-msg";
                status.innerHTML = "âŒ æ›´æ–°å¤±æ•—: " + err.message;
            }
        };
        reader.readAsArrayBuffer(file);
    }
</script>

</body>
</html>
