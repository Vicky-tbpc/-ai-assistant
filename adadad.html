<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†è€…å¾Œå° | ad03+ad05 æ•´åˆç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --tbp-blue: #8699a3; --bg-color: #f4f7f9; --card-bg: #ffffff; --text-dark: #333; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; color: var(--text-dark); }
        .admin-container { max-width: 1000px; margin: 0 auto; background: var(--card-bg); padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        header { border-bottom: 2px solid var(--tbp-blue); padding-bottom: 15px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; color: var(--tbp-blue); font-size: 24px; }
        .section-card { background: #fdfdfd; border: 1px solid #eee; border-radius: 10px; padding: 20px; margin-bottom: 25px; }
        .section-card h2 { margin-top: 0; font-size: 18px; color: #444; border-left: 4px solid var(--tbp-blue); padding-left: 10px; }
        .upload-group { display: flex; align-items: center; gap: 15px; margin-top: 15px; flex-wrap: wrap; }
        input[type="file"] { border: 1px solid #ddd; padding: 8px; border-radius: 5px; }
        button { background: var(--tbp-blue); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { opacity: 0.9; }
        .status-msg { margin-top: 12px; font-size: 0.9em; padding: 10px; border-radius: 5px; display: none; }
        .status-loading { display: block; background: #fff3cd; color: #856404; }
        .status-success { display: block; background: #d4edda; color: #155724; }
        .status-error { display: block; background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

<div class="admin-container">
    <header>
        <h1>å¥åº·å¤¥ä¼´ç®¡ç†ç³»çµ± (æ•´åˆç‰ˆ)</h1>
        <small>v05-ad03-integrated</small>
    </header>

    <div class="section-card">
        <h2>1. åŒæ­¥ç©¿æˆ´è£ç½®åŸå§‹æ•¸æ“š (å¥åº·æ•¸æ“š)</h2>
        <p style="font-size: 0.85em; color: #666;">ç³»çµ±å°‡è®€å– Excel åˆ†é åç¨±ä½œç‚ºã€Œåºè™Ÿã€ï¼Œä¸¦ä¾æ“š <b>record_end</b> æ¬„ä½è‡ªå‹•éæ¿¾é‡è¤‡æ—¥æœŸã€‚</p>
        <div class="upload-group">
            <input type="file" id="health-file" accept=".xlsx, .xls">
            <button onclick="uploadHealthData()">é–‹å§‹åŒæ­¥æ•¸æ“š</button>
        </div>
        <div id="health-status" class="status-msg"></div>
    </div>

    <div class="section-card">
        <h2>2. æ›´æ–°å»ºè­°è©å¥åº« (å« Battery/Daily_Tag ç­‰)</h2>
        <p style="font-size: 0.85em; color: #666;">ä¸Šå‚³åŒ…å« battery, Daily_Tag, best, worst, attention, goal, button ç­‰åˆ†é ä¹‹ Excelã€‚</p>
        <div class="upload-group">
            <input type="file" id="phrase-file" accept=".xlsx, .xls">
            <button onclick="uploadPhraseLibrary()">æ›´æ–°è©å¥åº«</button>
        </div>
        <div id="phrase-status" class="status-msg"></div>
    </div>
</div>

<script>
    // --- Supabase é…ç½® ---
    const SUPABASE_URL = 'https://æ‚¨çš„å°ˆæ¡ˆç¶²å€.supabase.co';
    const SUPABASE_KEY = 'æ‚¨çš„å…¬é–‹é‡‘é‘°';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    /**
     * ã€æ ¸å¿ƒé‚è¼¯ã€‘åŠŸèƒ½ 1ï¼šåŒæ­¥å¥åº·æ•¸æ“š (ad03 è¾¨è­˜æ–¹å¼)
     */
    async function uploadHealthData() {
        const fileInput = document.getElementById('health-file');
        const status = document.getElementById('health-status');

        if (!fileInput.files.length) { alert("è«‹å…ˆé¸æ“‡ Excel æª”æ¡ˆ"); return; }

        showStatus(status, "æ­£åœ¨è§£ææª”æ¡ˆä¸¦æ¯”å°è³‡æ–™åº«åºè™Ÿ...", "loading");

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // 1. å–å¾—è³‡æ–™åº«ä¸­ç¾æœ‰çš„åºè™Ÿ (ç¢ºä¿åªåŒ¯å…¥åˆæ³•ä½¿ç”¨è€…)
                const { data: users, error: userError } = await _supabase.from('user_credentials').select('serial_number');
                if (userError) throw userError;
                const validSerials = users.map(u => u.serial_number);

                // 2. ä½¿ç”¨ Map é€²è¡Œå»é‡ (Key: åºè™Ÿ_æ—¥æœŸ) -> é€™æ˜¯è§£æ±º ON CONFLICT çš„é—œéµ
                const dataMap = new Map();
                let matchedSheets = [];

                workbook.SheetNames.forEach(sheetName => {
                    const sn = sheetName.trim();
                    if (validSerials.includes(sn)) {
                        matchedSheets.push(sn);
                        const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

                        rows.forEach(row => {
                            // è®€å– record_end (ad03 é‚è¼¯)
                            const dateVal = row['record_end'];
                            if (dateVal) {
                                const d = new Date(dateVal);
                                if (!isNaN(d)) {
                                    // æ ¼å¼åŒ–æ—¥æœŸ YYYY-MM-DD
                                    const dateKey = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                                    const uniqueKey = `${sn}_${dateKey}`;
                                    
                                    // å­˜å…¥ Mapï¼ŒåŒåºè™ŸåŒæ—¥æœŸçš„è³‡æ–™ï¼Œå¾Œè€…æœƒè¦†è“‹å‰è€…ï¼Œä¿è­‰ä¸é‡è¤‡
                                    dataMap.set(uniqueKey, {
                                        serial_number: sn,
                                        record_date: dateKey,
                                        raw_json: row
                                    });
                                }
                            }
                        });
                    }
                });

                const uploadArray = Array.from(dataMap.values());
                if (uploadArray.length === 0) throw new Error("Excel ä¸­æ‰¾ä¸åˆ°åŒ¹é…çš„åºè™Ÿåˆ†é æˆ–æ—¥æœŸæ¬„ä½ã€‚");

                showStatus(status, `ğŸš€ è¾¨è­˜æˆåŠŸï¼ç™¼ç¾ ${matchedSheets.length} å€‹åŒ¹é…åˆ†é ï¼Œå…± ${uploadArray.length} ç­†ä¸é‡è¤‡æ•¸æ“šã€‚æ­£åœ¨ä¸Šå‚³...`, "loading");

                // 3. æ‰¹æ¬¡ä¸Šå‚³ (é¿å…è«‹æ±‚éå¤§)
                const chunkSize = 100;
                for (let i = 0; i < uploadArray.length; i += chunkSize) {
                    const chunk = uploadArray.slice(i, i + chunkSize);
                    const { error: upsertError } = await _supabase
                        .from('health_data')
                        .upsert(chunk, { onConflict: 'serial_number, record_date' });
                    
                    if (upsertError) throw upsertError;
                }

                showStatus(status, `âœ… åŒæ­¥æˆåŠŸï¼å·²è™•ç†åˆ†é ï¼š${matchedSheets.join(', ')}ã€‚å…±åŒ¯å…¥ ${uploadArray.length} ç­†æ•¸æ“šã€‚`, "success");

            } catch (err) {
                showStatus(status, "âŒ å¤±æ•—: " + err.message, "error");
                console.error(err);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    /**
     * åŠŸèƒ½ 2ï¼šæ›´æ–°è©å¥åº« (ad05 é‚è¼¯)
     */
    async function uploadPhraseLibrary() {
        const fileInput = document.getElementById('phrase-file');
        const status = document.getElementById('phrase-status');

        if (!fileInput.files.length) { alert("è«‹é¸æ“‡è©å¥åº«æª”æ¡ˆ"); return; }

        showStatus(status, "æ­£åœ¨è½‰æ›è©å¥æ ¼å¼...", "loading");

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                let allPhrases = [];

                workbook.SheetNames.forEach(sheetName => {
                    const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                    rows.forEach(row => {
                        let entry = { category: sheetName };

                        // ä¾æ“šä¸åŒåˆ†é å¥—ç”¨ ad05 çš„æ¬„ä½æ˜ å°„é‚è¼¯
                        if (sheetName === 'battery') {
                            entry.logic_key = `${row.TST_min}${row.N3_pct}${row.rMSSD}${row.HR_min}${row.HBI}`;
                            entry.title = row['é‡é»æ‘˜è¦'];
                            entry.simple_content = row['ä¸€å¥å¤§çœ¾æ˜“æ‡‚åˆå¼·èª¿å¥åº·åƒ¹å€¼çš„ç‰ˆæœ¬'];
                            entry.detailed_content = row['è©³ç´°è§£èªª'];
                        } 
                        else if (sheetName === 'Daily_Tag') {
                            entry.title = row['Daily_Tag'];
                            entry.simple_content = row['å»ºè­°'];
                            entry.detailed_content = row['å…§å®¹'] || row['__EMPTY'];
                        }
                        else if (['best', 'worst', 'attention', 'goal'].includes(sheetName)) {
                            entry.logic_key = row['å‚™è¨»'];
                            entry.detailed_content = row['æ³¨æ„'] || row['é”æ¨™'] || row['é‡é»æ‘˜è¦'];
                            entry.action_suggest = row['å»ºè­°'];
                        }
                        else if (sheetName === 'button') {
                            entry.title = row['é¸é …å•å¥'];
                            entry.detailed_content = row['å…§å®¹'];
                            entry.action_suggest = row['å‹•ä½œ'];
                        }

                        if (entry.title || entry.detailed_content || entry.logic_key) {
                            allPhrases.push(entry);
                        }
                    });
                });

                // å…ˆåˆªé™¤èˆŠè³‡æ–™å†æ’å…¥ (ad05 æ–¹å¼)
                await _supabase.from('phrase_library').delete().neq('category', 'system_temp');
                const { error: insError } = await _supabase.from('phrase_library').insert(allPhrases);
                
                if (insError) throw insError;
                showStatus(status, `âœ… è©å¥åº«æ›´æ–°å®Œç•¢ï¼å…±åŒ¯å…¥ ${allPhrases.length} ç­†å»ºè­°è©å¥ã€‚`, "success");

            } catch (err) {
                showStatus(status, "âŒ å¤±æ•—: " + err.message, "error");
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // ç‹€æ…‹é¡¯ç¤ºè¼”åŠ©å‡½å¼
    function showStatus(el, msg, type) {
        el.innerText = msg;
        el.className = "status-msg status-" + type;
    }
</script>

</body>
</html>
