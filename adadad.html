<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†è€…å¾Œå° | å¥åº·å¤¥ä¼´ç®¡ç†ç³»çµ± 03</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --tbp-blue: #8699a3;
            --bg-color: #f4f7f9;
            --card-bg: #ffffff;
            --text-dark: #333;
            --danger: #ff8c73;
        }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; color: var(--text-dark); }
        .hidden { display: none !important; }

        /* ä»‹é¢å®¹å™¨ */
        .admin-container { max-width: 1100px; margin: 20px auto; background: var(--card-bg); padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        /* é é¦–æ¨£å¼ */
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--tbp-blue); padding-bottom: 15px; margin-bottom: 20px; }
        h1 { color: var(--tbp-blue); margin: 0; font-size: 1.5rem; }
        
        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group { display: flex; gap: 10px; }
        button { padding: 10px 18px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .primary-btn { background: var(--tbp-blue); color: white; }
        .outline-btn { background: #eee; color: #666; }
        .danger-btn { background: var(--danger); color: white; }

        /* å½ˆçª—æ¨£å¼ */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .modal-card { background: white; padding: 25px; border-radius: 10px; width: 100%; max-width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }

        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8f9fa; color: #666; text-align: left; padding: 12px; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .status-tag { font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; background: #eee; color: #888; }
        .active-tag { background: #e6f0f9; color: #5a7d9a; }

        /* ä¸Šå‚³ç‹€æ…‹é¡¯ç¤ºå€ */
        #upload-status { margin-top: 10px; padding: 10px; border-radius: 4px; font-size: 0.9rem; line-height: 1.5; }
    </style>
</head>
<body>

    <div id="admin-login-overlay" class="modal-overlay" style="background: #f5f1eb; z-index:3000;">
        <div class="modal-card" style="text-align: center;">
            <h2 style="color: var(--tbp-blue);">ç®¡ç†è€…ç™»å…¥</h2>
            <input type="password" id="admin-password-input" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼">
            <button class="primary-btn" style="width: 100%;" onclick="checkAdminAuth()">ç™»å…¥å¾Œå°</button>
        </div>
    </div>

    <div id="add-user-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <h3>æ–°å¢ä½¿ç”¨è€…åºè™Ÿ</h3>
            <input type="text" id="new-serial" placeholder="è¼¸å…¥æ–°åºè™Ÿ (å¦‚: BA001)">
            <input type="text" id="new-password" placeholder="é è¨­å¯†ç¢¼">
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="outline-btn" style="flex:1" onclick="closeAddModal()">å–æ¶ˆ</button>
                <button class="primary-btn" style="flex:1" onclick="confirmAddUser()">ç¢ºèªæ–°å¢</button>
            </div>
        </div>
    </div>

    <div id="main-admin-content" class="admin-container hidden">
        <header>
            <h1>å¥åº·å¤¥ä¼´ç®¡ç†ç³»çµ±</h1>
            <div class="btn-group">
                <button class="primary-btn" onclick="openAddModal()">ï¼‹ æ–°å¢ä½¿ç”¨è€…</button>
                <button class="danger-btn" onclick="adminLogout()">ç™»å‡º</button>
            </div>
        </header>

        <div style="margin-bottom: 20px; padding: 20px; border: 2px dashed var(--tbp-blue); border-radius: 8px; background: #fcfcfc;">
            <label style="font-weight: bold; display: block; margin-bottom: 10px;">ğŸ“Š åŒæ­¥å¥åº·æ•¸æ“š (è®€å– record_end)ï¼š</label>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <input type="file" id="excel-upload" accept=".xlsx, .xls" style="width: auto; margin: 0;">
                <button class="primary-btn" onclick="handleExcelUpload()">é–‹å§‹è¾¨è­˜ä¸¦åŒ¯å…¥</button>
            </div>
            <div id="upload-status"></div>
        </div>

        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>åºè™Ÿ (åˆ†é å)</th>
                        <th>å¯†ç¢¼</th>
                        <th>æš±ç¨±</th>
                        <th>å¤¥ä¼´åå­—</th>
                        <th>å»ºç«‹æ™‚é–“</th>
                    </tr>
                </thead>
                <tbody id="user-list">
                    <tr><td colspan="5" style="text-align:center;">è«‹å…ˆç™»å…¥ä»¥è¼‰å…¥è³‡æ–™...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://gcvwebgfbrsrezxvjafe.supabase.co";
        const SUPABASE_KEY = "sb_publishable_H_-X-v5cU7I3IHjml2CGUQ_FUK6teZs";
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const ADMIN_PW = "888tBPC!!";

        // --- ç®¡ç†è€…é©—è­‰é‚è¼¯ ---
        function checkAdminAuth() {
            const input = document.getElementById('admin-password-input').value;
            if (input === ADMIN_PW) {
                document.getElementById('admin-login-overlay').classList.add('hidden');
                document.getElementById('main-admin-content').classList.remove('hidden');
                loadUsers();
            } else {
                alert("ç®¡ç†å¯†ç¢¼éŒ¯èª¤ï¼");
            }
        }

        function adminLogout() {
            location.reload();
        }

        // --- æ–°å¢ä½¿ç”¨è€…é‚è¼¯ ---
        function openAddModal() { document.getElementById('add-user-modal').classList.remove('hidden'); }
        function closeAddModal() { document.getElementById('add-user-modal').classList.add('hidden'); }

        async function confirmAddUser() {
            const serial = document.getElementById('new-serial').value.trim();
            const pw = document.getElementById('new-password').value.trim();
            if (!serial || !pw) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");

            const { error } = await _supabase.from('user_credentials').insert([{ serial_number: serial, password: pw }]);
            if (error) {
                alert("æ–°å¢å¤±æ•—: " + error.message);
            } else {
                alert("ä½¿ç”¨è€… " + serial + " å·²æ–°å¢ï¼");
                document.getElementById('new-serial').value = "";
                document.getElementById('new-password').value = "";
                closeAddModal();
                loadUsers();
            }
        }

        // --- ä½¿ç”¨è€…æ¸…å–®è¼‰å…¥ ---
        async function loadUsers() {
            const tbody = document.getElementById('user-list');
            const { data, error } = await _supabase.from('user_credentials').select('*').order('created_at', { ascending: false });
            if (error) {
                tbody.innerHTML = `<tr><td colspan="5" style="color:red;">è¼‰å…¥å¤±æ•—: ${error.message}</td></tr>`;
                return;
            }
            tbody.innerHTML = "";
            data.forEach(user => {
                const date = new Date(user.created_at).toLocaleDateString();
                tbody.innerHTML += `
                    <tr>
                        <td><strong>${user.serial_number}</strong></td>
                        <td><code>${user.password}</code></td>
                        <td>${user.nickname ? `<span class="status-tag active-tag">${user.nickname}</span>` : '<span class="status-tag">æœªè¨­å®š</span>'}</td>
                        <td>${user.ai_name ? `<span class="status-tag active-tag">${user.ai_name}</span>` : '<span class="status-tag">æœªå‘½å</span>'}</td>
                        <td style="color: #888; font-size: 0.85rem;">${date}</td>
                    </tr>
                `;
            });
        }

        // --- Excel åŒ¯å…¥é‚è¼¯ (é‡é»ä¿®æ­£) ---
        async function handleExcelUpload() {
            const fileInput = document.getElementById('excel-upload');
            const status = document.getElementById('upload-status');
            if (!fileInput.files[0]) return alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆ");

            status.style.color = "#666";
            status.innerHTML = "â³ æ­£åœ¨è¾¨è­˜åˆ†é ä¸¦è™•ç†æ—¥æœŸè³‡æ–™...";

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    // è®“ SheetJS è‡ªå‹•å˜—è©¦æ—¥æœŸè½‰æ›
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    
                    // 1. å…ˆç²å–ç›®å‰å·²å»ºç«‹çš„ä½¿ç”¨è€…åºè™Ÿæ¸…å–®
                    const { data: users } = await _supabase.from('user_credentials').select('serial_number');
                    const validSerials = users.map(u => u.serial_number);

                    const dataMap = new Map();
                    let matchedSheets = [];

                    // 2. éæ­· Excel è£¡çš„æ‰€æœ‰åˆ†é 
                    for (const sheetName of workbook.SheetNames) {
                        // 3. åªæœ‰åˆ†é åç¨±åœ¨ä½¿ç”¨è€…æ¸…å–®å…§æ‰è™•ç†
                        if (validSerials.includes(sheetName)) {
                            matchedSheets.push(sheetName);
                            const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                            
                            sheetData.forEach(row => {
                                // 4. è¾¨è­˜ record_end æ¬„ä½
                                let rawDate = row.record_end; 
                                let formattedDate = null;

                                if (rawDate) {
                                    if (rawDate instanceof Date) {
                                        // è½‰æ›ç‚º YYYY-MM-DD
                                        formattedDate = rawDate.toISOString().split('T')[0];
                                    } else if (typeof rawDate === 'number') {
                                        // è™•ç† Excel åºåˆ—æ•¸å­—
                                        const dateObj = XLSX.SSF.parse_date_code(rawDate);
                                        formattedDate = `${dateObj.y}-${String(dateObj.m).padStart(2, '0')}-${String(dateObj.d).padStart(2, '0')}`;
                                    } else {
                                        // è™•ç†å­—ä¸²æ ¼å¼
                                        formattedDate = String(rawDate).split(' ')[0].replace(/\//g, '-');
                                    }
                                }

                                // 5. ä½¿ç”¨ Map å»é‡ï¼Œä¿ç•™ç•¶å¤©æœ€å¾Œä¸€ç­†
                                if (formattedDate && formattedDate !== "undefined") {
                                    const uniqueKey = `${sheetName}_${formattedDate}`;
                                    dataMap.set(uniqueKey, {
                                        serial_number: sheetName,
                                        record_date: formattedDate,
                                        raw_json: row
                                    });
                                }
                            });
                        }
                    }

                    const allData = Array.from(dataMap.values());
                    if (allData.length === 0) throw new Error("æ‰¾ä¸åˆ°èˆ‡ä½¿ç”¨è€…åºè™ŸåŒ¹é…çš„åˆ†é æ•¸æ“šã€‚");

                    status.innerHTML = `ğŸš€ å·²è­˜åˆ¥åˆ†é : ${matchedSheets.join(', ')}<br>åŒæ­¥ä¸­: ${allData.length} ç­†æ•¸æ“š...`;
                    
                    // 6. æ‰¹æ¬¡å¯«å…¥ Supabase (æ¯ 100 ç­†ä¸€çµ„)
                    const chunkSize = 100;
                    for (let i = 0; i < allData.length; i += chunkSize) {
                        const chunk = allData.slice(i, i + chunkSize);
                        const { error } = await _supabase.from('health_data').upsert(chunk, { onConflict: 'serial_number, record_date' });
                        if (error) throw error;
                    }

                    status.style.color = "green";
                    status.innerHTML = `âœ… åŒæ­¥æˆåŠŸï¼<br>å·²è¾¨è­˜åˆ†é ï¼š${matchedSheets.length} å€‹<br>ç¸½åŒ¯å…¥ç­†æ•¸ï¼š${allData.length}`;
                    
                } catch (err) {
                    status.style.color = "red";
                    status.innerHTML = "âŒ åŒ¯å…¥å¤±æ•—: " + err.message;
                    console.error(err);
                }
            };
            reader.readAsArrayBuffer(fileInput.files[0]);
        }
    </script>
</body>
</html>

