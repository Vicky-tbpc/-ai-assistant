<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†è€…å¾Œå° | å¥åº·å¤¥ä¼´ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
   
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>



    <style>
        :root {
            --tbp-blue: #8699a3;
            --bg-color: #f4f7f9;
            --card-bg: #ffffff;
            --text-dark: #333;
            --danger: #ff8c73;
        }

        body {
            font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0;
            color: var(--text-dark);
        }

        .hidden { display: none !important; }

        /* --- ç®¡ç†è€…ç™»å…¥ä»‹é¢ --- */
        #admin-login-overlay {
            position: fixed; inset: 0; background: #e2ddd4;
            display: flex; justify-content: center; align-items: center; z-index: 3000;
        }

        /* --- ä¸»å®¹å™¨ --- */
        .admin-container {
            max-width: 1100px; margin: 20px auto;
            background: var(--card-bg); padding: 30px;
            border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid var(--tbp-blue); padding-bottom: 15px; margin-bottom: 20px;
        }

        h1 { color: var(--tbp-blue); margin: 0; font-size: 1.5rem; }

        .btn-group { display: flex; gap: 10px; }

        button {
            padding: 10px 18px; border-radius: 6px; border: none;
            cursor: pointer; font-weight: bold; transition: 0.2s;
        }

        .primary-btn { background: var(--tbp-blue); color: white; }
        .outline-btn { background: #eee; color: #666; }
        .danger-btn { background: var(--danger); color: white; }

        /* --- è¡¨å–®å½ˆçª— --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-card {
            background: white; padding: 25px; border-radius: 10px;
            width: 100%; max-width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        input {
            width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd;
            border-radius: 6px; box-sizing: border-box; font-size: 14px;
        }

        /* --- è¡¨æ ¼ --- */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8f9fa; color: #666; text-align: left; padding: 12px; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .status-tag { font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; background: #eee; color: #888; }
        .active-tag { background: #e6f0f9; color: #5a7d9a; }
    </style>
</head>
<body>

    <div id="admin-login-overlay">
        <div class="modal-card" style="text-align: center;">
            <h2 style="color: var(--tbp-blue);">ç®¡ç†è€…ç™»å…¥</h2>
            <input type="password" id="admin-password-input" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼">
            <button class="primary-btn" style="width: 100%;" onclick="checkAdminAuth()">ç™»å…¥å¾Œå°</button>
        </div>
    </div>

    <div id="add-user-modal" class="modal-overlay hidden">
        <div class="modal-card">
            <h3>æ–°å¢ä½¿ç”¨è€…åºè™Ÿ</h3>
            <input type="text" id="new-serial" placeholder="è¼¸å…¥æ–°åºè™Ÿ (ä¾‹å¦‚: BA001)">
            <input type="text" id="new-password" placeholder="é è¨­å¯†ç¢¼">
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="outline-btn" style="flex:1" onclick="closeAddModal()">å–æ¶ˆ</button>
                <button class="primary-btn" style="flex:1" onclick="confirmAddUser()">ç¢ºèªæ–°å¢</button>
            </div>
        </div>
    </div>

    <div id="main-admin-content" class="admin-container hidden">
        <header>
            <h1>å¥åº·å¤¥ä¼´ç®¡ç†ç³»çµ±</h1>
            <div class="btn-group">
                <button class="primary-btn" onclick="openAddModal()">ï¼‹ æ–°å¢ä½¿ç”¨è€…</button>
                <button class="outline-btn" onclick="loadUsers()">ğŸ”„ åˆ·æ–°</button>
                <button class="danger-btn" onclick="adminLogout()">ç™»å‡º</button>
            </div>
        </header>

        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>åºè™Ÿ</th>
                        <th>å¯†ç¢¼</th>
                        <th>æš±ç¨±</th>
                        <th>å¤¥ä¼´åå­—</th>
                        <th>å»ºç«‹æ™‚é–“</th>
                    </tr>
                </thead>
                <tbody id="user-list">
                    <tr><td colspan="5" style="text-align:center;">è¼‰å…¥ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

<div style="margin-bottom: 20px; padding: 15px; border: 1px dashed var(--tbp-blue); border-radius: 8px;">
    <label>ğŸ“Š ä¸Šå‚³å¥åº·æ•¸æ“š Excelï¼š</label>
    <input type="file" id="excel-upload" accept=".xlsx, .xls" style="width: auto;">
    <button class="primary-btn" onclick="handleExcelUpload()">é–‹å§‹åŒ¯å…¥æ•¸æ“š</button>
    <div id="upload-status" style="margin-top: 10px; font-size: 0.9rem; color: #666;"></div>
</div>


    <script>
        const SUPABASE_URL = "https://gcvwebgfbrsrezxvjafe.supabase.co";
        const SUPABASE_KEY = "sb_publishable_H_-X-v5cU7I3IHjml2CGUQ_FUK6teZs";
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const ADMIN_PW = "888tBPC!!";

        // --- ç®¡ç†è€…é©—è­‰ ---
        function checkAdminAuth() {
            const input = document.getElementById('admin-password-input').value;
            if (input === ADMIN_PW) {
                document.getElementById('admin-login-overlay').classList.add('hidden');
                document.getElementById('main-admin-content').classList.remove('hidden');
                loadUsers();
            } else {
                alert("ç®¡ç†å¯†ç¢¼éŒ¯èª¤ï¼");
            }
        }

        function adminLogout() {
            location.reload(); // æœ€ç°¡å–®çš„ç™»å‡ºæ–¹å¼ï¼šé‡æ–°æ•´ç†
        }

        // --- æ–°å¢ä½¿ç”¨è€…é‚è¼¯ ---
        function openAddModal() { document.getElementById('add-user-modal').classList.remove('hidden'); }
        function closeAddModal() { document.getElementById('add-user-modal').classList.add('hidden'); }

        async function confirmAddUser() {
            const serial = document.getElementById('new-serial').value;
            const pw = document.getElementById('new-password').value;

            if (!serial || !pw) return alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š");

            const { error } = await _supabase
                .from('user_credentials')
                .insert([{ serial_number: serial, password: pw }]);

            if (error) {
                alert("æ–°å¢å¤±æ•—: " + error.message);
            } else {
                alert("ä½¿ç”¨è€… " + serial + " å·²æˆåŠŸæ–°å¢ï¼");
                document.getElementById('new-serial').value = "";
                document.getElementById('new-password').value = "";
                closeAddModal();
                loadUsers();
            }
        }

        // --- è³‡æ–™è¼‰å…¥ ---
        async function loadUsers() {
            const tbody = document.getElementById('user-list');
            try {
                const { data, error } = await _supabase
                    .from('user_credentials')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                tbody.innerHTML = "";

                data.forEach(user => {
                    const date = new Date(user.created_at).toLocaleString('zh-TW');
                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${user.serial_number}</strong></td>
                            <td><code>${user.password}</code></td>
                            <td>${user.nickname ? `<span class="status-tag active-tag">${user.nickname}</span>` : '<span class="status-tag">æœªè¨­å®š</span>'}</td>
                            <td>${user.ai_name ? `<span class="status-tag active-tag">${user.ai_name}</span>` : '<span class="status-tag">æœªå‘½å</span>'}</td>
                            <td style="color: #888; font-size: 0.85rem;">${date}</td>
                        </tr>
                    `;
                });
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan='5' style='text-align:center; color:red;'>éŒ¯èª¤: ${err.message}</td></tr>`;
            }
        }

async function handleExcelUpload() {
    const fileInput = document.getElementById('excel-upload');
    const status = document.getElementById('upload-status');
    if (!fileInput.files[0]) return alert("è«‹å…ˆé¸æ“‡æª”æ¡ˆ");

    status.innerHTML = "â³ æ­£åœ¨è§£æ Excel æª”æ¡ˆ...";
    const reader = new FileReader();
    
    reader.onload = async (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            
            // 1. ç²å–æœ‰æ•ˆä½¿ç”¨è€…æ¸…å–®
            const { data: users, error: userError } = await _supabase.from('user_credentials').select('serial_number');
            if (userError) throw new Error("è®€å–ä½¿ç”¨è€…æ¸…å–®å¤±æ•—: " + userError.message);
            const validSerials = users.map(u => u.serial_number);

            let totalImported = 0;
            let sheetsProcessed = 0;
            let allDataToUpsert = []; // ç”¨æ–¼æ‰¹æ¬¡ä¸Šå‚³

            // 2. éæ­·æ‰€æœ‰åˆ†é 
            for (const sheetName of workbook.SheetNames) {
                if (validSerials.includes(sheetName)) {
                    sheetsProcessed++;
                    const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                    
                    sheetData.forEach(row => {
                        // å¼·å¥çš„æ—¥æœŸæå–é‚è¼¯
                        let recDate = null;
                        if (row.record_start) {
                            // è™•ç†å­—ä¸²æˆ–æ—¥æœŸç‰©ä»¶
                            const dateStr = String(row.record_start); 
                            recDate = dateStr.includes(' ') ? dateStr.split(' ')[0] : dateStr;
                        }

                        if (recDate && recDate !== "undefined") {
                            allDataToUpsert.push({
                                serial_number: sheetName,
                                record_date: recDate,
                                raw_json: row
                            });
                        }
                    });
                }
            }

            if (allDataToUpsert.length === 0) {
                status.innerHTML = "âŒ æ‰¾ä¸åˆ°åŒ¹é…çš„åºè™Ÿåˆ†é æˆ–è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºã€‚";
                return;
            }

            status.innerHTML = `ğŸš€ æ­£åœ¨ä¸Šå‚³ ${allDataToUpsert.length} ç­†æ•¸æ“šè‡³è³‡æ–™åº«...`;

            // 3. æ‰¹æ¬¡ä¸Šå‚³ (æ¯ 100 ç­†ä¸€çµ„ï¼Œé¿å…è«‹æ±‚éå¤§)
            const chunkSize = 100;
            for (let i = 0; i < allDataToUpsert.length; i += chunkSize) {
                const chunk = allDataToUpsert.slice(i, i + chunkSize);
                const { error: upsertError } = await _supabase
                    .from('health_data')
                    .upsert(chunk, { onConflict: 'serial_number, record_date' });
                
                if (upsertError) throw upsertError;
            }

            status.innerHTML = `âœ… æˆåŠŸï¼è™•ç†äº† ${sheetsProcessed} å€‹åˆ†é ï¼Œå…±æ›´æ–° ${allDataToUpsert.length} ç­†æ•¸æ“šã€‚`;
            loadUsers();

        } catch (err) {
            console.error("åŒ¯å…¥éç¨‹ä¸­å‡ºéŒ¯:", err);
            status.innerHTML = `<span style="color:red;">âŒ åŒ¯å…¥å¤±æ•—: ${err.message}</span>`;
        }
    };

    reader.onerror = () => {
        status.innerHTML = "âŒ æª”æ¡ˆè®€å–å¤±æ•—ã€‚";
    };
    
    reader.readAsArrayBuffer(fileInput.files[0]);
}


    </script>
</body>
</html>
