<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soosyn AI 健康助理17</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --brand-blue: #6c83cf; --text-main: #5a5a5a; --bg-gray: #f8f9fa; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: var(--bg-gray); color: var(--text-main); }
        .summary-pill { background: #f0f0f0; border-radius: 30px; padding: 12px 20px; font-size: 13px; display: flex; align-items: center; }
        .score-display { font-size: 72px; font-weight: 900; line-height: 1; }
        .modal-bg { background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .chat-bubble-ai { background: white; border-radius: 20px 20px 20px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="loginSection" class="fixed inset-0 z-[1000] bg-white flex flex-col items-center justify-center p-6">
        <div class="max-w-xs w-full text-center">
            <h1 class="text-3xl font-bold text-[#6c83cf] mb-8">Soosyn AI</h1>
            <input id="serviceID" type="text" placeholder="服務序號 (如 BA000001)" class="w-full border-2 p-3 rounded-xl mb-4 text-center">
            <input id="password" type="password" placeholder="密碼" class="w-full border-2 p-3 rounded-xl mb-4 text-center">
            <button onclick="handleLogin()" class="w-full bg-[#6c83cf] text-white py-3 rounded-xl font-bold">登入</button>
            <button onclick="document.getElementById('adminLoginModal').classList.remove('hidden')" class="mt-8 text-xs text-gray-300">管理員登入</button>
        </div>
    </div>

    <div id="mainSection" class="hidden flex flex-col h-screen">
        <header class="p-4 bg-white border-b flex justify-between items-center shadow-sm">
            <span class="font-bold text-[#6c83cf]">Soosyn AI 助理</span>
            <button onclick="openSummaryModal()" class="text-xs bg-blue-50 text-[#6c83cf] px-4 py-2 rounded-full font-bold">查看今日摘要</button>
        </header>
        <main id="chatBox" class="flex-grow overflow-y-auto p-4 space-y-4 bg-[#f8f9fa]"></main>
        <footer class="p-4 bg-white border-t">
            <div class="flex items-center bg-gray-100 rounded-2xl px-4 py-2 max-w-2xl mx-auto">
                <input id="userInput" type="text" placeholder="詢問您的健康狀況..." class="flex-grow bg-transparent outline-none p-2">
                <button onclick="askGemini()" class="text-[#6c83cf] p-2"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </footer>
    </div>

    <div id="summaryModal" class="hidden fixed inset-0 modal-bg z-[500] flex items-center justify-center p-4">
        <div class="bg-white rounded-[2.5rem] max-w-md w-full max-h-[90vh] overflow-y-auto p-8 relative">
            <button onclick="document.getElementById('summaryModal').classList.add('hidden')" class="absolute top-6 right-6 text-2xl text-gray-300">&times;</button>
            
            <div class="flex items-center text-[#5a5a5a] mb-6 space-x-2 relative">
                <i class="fa-solid fa-calendar-days text-[#8699a3]"></i>
                <span id="currDateDisplay" class="font-normal">請選擇日期</span>
                <input type="date" id="datePicker" class="absolute inset-0 opacity-0 cursor-pointer" onchange="renderSummary(this.value)">
            </div>

            <div class="text-center mb-6">
                <p class="text-xs font-bold text-[#6c83cf] mb-2">生理電量</p>
                <div id="mainScore" class="score-display">--</div>
                <div id="rankText" class="text-xs text-[#5a5a5a] mt-4 mb-4">正在計算...</div>
                <div class="flex items-center justify-center space-x-2 bg-gray-50 py-2 px-4 rounded-full inline-flex">
                    <span id="statusIcon" class="w-3 h-3 rounded-full bg-gray-300"></span>
                    <span id="statusLabel" class="text-xs font-bold text-[#5a5a5a]">讀取中</span>
                </div>
            </div>

            <div class="space-y-3 mb-6">
                <div class="summary-pill"><i class="fa-solid fa-face-smile text-[#a0afb7] mr-3 text-xl"></i><span id="bestText">--</span></div>
                <div class="summary-pill"><i class="fa-solid fa-face-frown text-[#ff8c73] mr-3 text-xl"></i><span id="worstText">--</span></div>
                <div id="batterySummaryText" class="bg-[#f0f0f0] rounded-2xl p-4 text-xs text-[#5a5a5a] leading-relaxed">--</div>
            </div>

            <div class="border-t pt-4 space-y-2 mb-6 text-xs">
                <div class="flex items-start space-x-2"><i class="fa-solid fa-triangle-exclamation text-[#ff8c73] mt-1"></i><p id="attentionText" class="text-[#ff8c73]">--</p></div>
                <div class="flex items-start space-x-2"><i class="fa-solid fa-circle-info text-[#a79d8c] mt-1"></i><p id="suggestionText" class="text-[#a79d8c]">--</p></div>
            </div>

            <div class="bg-blue-50 p-4 rounded-2xl flex items-start space-x-3">
                <div class="flex space-x-0.5 text-[#8699a3] mt-1"><i class="fa-solid fa-flag"></i><i class="fa-solid fa-flag"></i><i class="fa-solid fa-flag"></i></div>
                <p id="goalText" class="text-xs text-[#6c838f]">--</p>
            </div>
        </div>
    </div>

    <div id="adminPanel" class="hidden fixed inset-0 bg-white z-[2000] p-8 overflow-y-auto">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold">Soosyn 管理後台</h2>
                <button onclick="document.getElementById('adminPanel').classList.add('hidden')" class="text-gray-500">關閉</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="border-2 border-dashed p-6 rounded-2xl">
                    <h3 class="font-bold mb-4">1. 上傳健康數據 (Excel)</h3>
                    <input type="file" id="file1" accept=".xlsx, .csv" class="text-xs mb-4">
                    <button onclick="uploadFile1()" class="w-full bg-blue-500 text-white py-2 rounded-lg text-sm">執行同步</button>
                </div>
                <div class="border-2 border-dashed p-6 rounded-2xl">
                    <h3 class="font-bold mb-4">2. 上傳用戶名冊 (Excel)</h3>
                    <input type="file" id="file2" accept=".xlsx, .csv" class="text-xs mb-4">
                    <button onclick="uploadFile2()" class="w-full bg-green-500 text-white py-2 rounded-lg text-sm">更新用戶</button>
                </div>
                <div class="border-2 border-dashed p-6 rounded-2xl">
                    <h3 class="font-bold mb-4">3. 上傳詞句庫 (Excel)</h3>
                    <input type="file" id="file3" accept=".xlsx, .csv" class="text-xs mb-4">
                    <button onclick="uploadFile3()" class="w-full bg-purple-500 text-white py-2 rounded-lg text-sm">載入詞句</button>
                </div>
            </div>
        </div>
    </div>

    <div id="adminLoginModal" class="hidden fixed inset-0 modal-bg z-[1500] flex items-center justify-center">
        <div class="bg-white p-8 rounded-3xl w-80">
            <input id="admPass" type="password" placeholder="管理員密碼" class="w-full border p-4 rounded-xl mb-4 text-center">
            <button onclick="checkAdmin()" class="w-full bg-red-500 text-white py-3 rounded-xl font-bold">進入後台</button>
            <button onclick="document.getElementById('adminLoginModal').classList.add('hidden')" class="w-full mt-2 text-gray-400 text-sm">取消</button>
        </div>
    </div>

    <script>
        // --- 核心配置 ---
        const SUPABASE_URL = 'https://gcvwebgfbrsrezxvjafe.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_H_-X-v5cU7I3IHjml2CGUQ_FUK6teZs'; 
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let globalPhraseData = {}; 
        let currentRecords = [];

        // --- 登入邏輯 ---
        async function handleLogin() {
            const sid = document.getElementById('serviceID').value.trim();
            const pwd = document.getElementById('password').value.trim();
            const { data, error } = await _supabase.from('user_profiles').select('*').eq('service_id', sid).single();
            
            if (data && data.password === pwd) {
                currentUser = data;
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainSection').classList.remove('hidden');
                initUserData();
            } else {
                alert("序號或密碼錯誤，請確認 Supabase 已同步。");
            }
        }

        async function initUserData() {
            const { data } = await _supabase.from('health_records')
                .select('*')
                .eq('service_id', currentUser.service_id)
                .order('record_date', {ascending: false});
            
            currentRecords = data || [];
            if(currentRecords.length > 0) {
                const latestDate = currentRecords[0].record_date;
                renderSummary(latestDate);
            }
        }

        // --- 復刻 04 版上傳邏輯 (不限制 BA 開頭，自動讀取所有 Sheet) ---
        async function uploadFile1() {
            const file = document.getElementById('file1').files[0];
            if (!file) return alert("請先選擇 Excel 檔案");

            const reader = new FileReader();
            reader.onload = async (e) => {
                // 使用 cellDates: true 讓 Excel 自動解析日期
                const wb = XLSX.read(e.target.result, { type: 'array', cellDates: true });
                let totalCount = 0;
                let sheetList = [];

                // 遍歷所有工作表 (不設限 BA，就像 04 版一樣)
                for (const name of wb.SheetNames) {
                    const data = XLSX.utils.sheet_to_json(wb.Sheets[name], { defval: "" });
                    
                    if (data.length === 0) continue;

                    // 批次轉換資料
                    const batch = data.map(r => {
                        // 1. 抓取日期 (優先找 record_end，若沒有則找 record_date)
                        // 注意：04 版是用 r.record_end || r.record_date
                        let rawDate = r.record_end || r.record_date || r.Record_End || r.Record_Date;
                        if (!rawDate) return null;

                        // 日期格式化 (去除時間)
                        let dateOnly = null;
                        try {
                            if (rawDate instanceof Date) {
                                // 修正時區偏移
                                const offset = rawDate.getTimezoneOffset() * 60000;
                                dateOnly = new Date(rawDate.getTime() - offset).toISOString().split('T')[0];
                            } else {
                                // 如果是字串 "2026/2/10 5:31"
                                const d = new Date(rawDate);
                                if (!isNaN(d.getTime())) dateOnly = d.toISOString().split('T')[0];
                            }
                        } catch (err) { return null; }

                        if (!dateOnly) return null;

                        return {
                            service_id: name.trim(), // 去除空格
                            record_date: dateOnly,
                            // 2. 抓取分數 (兼容 04 版 Battery_score 與 CSV 實際欄位)
                            battery_score: r.Personal_Battery_weighted_round || r.Battery_score || 0,
                            raw_data: r
                        };
                    }).filter(item => item !== null);

                    if (batch.length > 0) {
                        const { error } = await _supabase.from('health_records').upsert(batch, { 
                            onConflict: 'service_id, record_date' 
                        });
                        
                        if (!error) {
                            totalCount += batch.length;
                            sheetList.push(name);
                        }
                    }
                }

                alert(`同步完成！\n成功匯入工作表: ${sheetList.join(', ')}\n總筆數: ${totalCount}`);
                if (currentUser) initUserData();
            };
            reader.readAsArrayBuffer(file);
        }

        // --- A2-A8 渲染與計算 ---
        async function renderSummary(targetDateStr) {
            const target = currentRecords.find(r => r.record_date.startsWith(targetDateStr));
            if(!target) return;

            document.getElementById('currDateDisplay').innerText = targetDateStr.replace(/-/g, '/');
            const score = Math.round(target.battery_score || 0);
            const scoreEl = document.getElementById('mainScore');
            scoreEl.innerText = score;

            // 顏色與狀態判定
            const colors = { red: "#ff8c73", tan: "#a79d8c", gray: "#a0adb7", navy: "#596b75" };
            scoreEl.style.color = score >= 90 ? colors.navy : score >= 80 ? colors.gray : score >= 60 ? colors.tan : colors.red;
            
            document.getElementById('statusLabel').innerText = currentUser.manual_status || "平衡中";
            const lightMap = { "紅燈": "#ff0000", "黃紅燈": "#ff8000", "黃燈": "#ffe632", "綠燈": "#3caa28" };
            document.getElementById('statusIcon').style.backgroundColor = lightMap[currentUser.manual_status] || "#ccc";

            // 這裡簡單示範，實際需配合 uploadFile3 的資料
            if(globalPhraseData.best) {
                document.getElementById('bestText').innerText = "今日生理狀態優於昨日表現";
                document.getElementById('goalText').innerText = "連續 3 天達標：睡眠充足！";
            }
        }

        async function uploadFile2() {
            const file = document.getElementById('file2').files[0];
            const reader = new FileReader();
            reader.onload = async (e) => {
                const wb = XLSX.read(e.target.result, {type:'array'});
                // 假設名冊在第一個 sheet
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const batch = data.map(r => ({
                    service_id: r.service_id || r['序號'], // 容錯
                    password: r.password || r['密碼'] || 'tbpc',
                    manual_status: r.manual_status || r['狀態']
                })).filter(r => r.service_id);

                await _supabase.from('user_profiles').upsert(batch, { onConflict: 'service_id' });
                alert(`用戶名冊更新完畢，共 ${batch.length} 筆`);
            };
            reader.readAsArrayBuffer(file);
        }

        async function uploadFile3() {
            const file = document.getElementById('file3').files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const wb = XLSX.read(e.target.result, {type:'array'});
                wb.SheetNames.forEach(n => {
                    globalPhraseData[n.toLowerCase()] = XLSX.utils.sheet_to_json(wb.Sheets[n]);
                });
                alert("詞句庫載入成功");
            };
            reader.readAsArrayBuffer(file);
        }

        // --- Gemini API ---
        async function askGemini() {
            const input = document.getElementById('userInput');
            const msg = input.value.trim();
            if(!msg) return;

            appendMessage('user', msg);
            input.value = '';

            const loadingId = 'loading-' + Date.now();
            appendMessage('ai', '思考中...', loadingId);

            try {
                // 請將此處替換為您的 Vercel Proxy URL
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        prompt: `用戶資料: ${JSON.stringify(currentRecords.slice(0,1))}\n問題: ${msg}` 
                    })
                });
                const data = await response.json();
                
                const bubble = document.getElementById(loadingId);
                if (bubble) bubble.innerText = data.text || "無法回應";
            } catch (err) {
                const bubble = document.getElementById(loadingId);
                if (bubble) bubble.innerText = "連線異常";
            }
        }

        function appendMessage(role, text, id = '') {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.id = id;
            div.className = role === 'ai' ? "chat-bubble-ai p-4 text-sm max-w-[85%] leading-relaxed" : 
                            "bg-[#6c83cf] text-white self-end p-4 rounded-2xl rounded-tr-none text-sm max-w-[85%] flex ml-auto shadow-md";
            div.innerText = text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function checkAdmin() {
            if(document.getElementById('admPass').value === '888tBPC!!') {
                document.getElementById('adminLoginModal').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
            } else alert("密碼錯誤");
        }

        function openSummaryModal() {
            if(currentRecords.length === 0) return alert("尚無數據");
            document.getElementById('summaryModal').classList.remove('hidden');
        }
    </script>
</body>
</html>
