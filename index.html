<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>健康摘要卡片 - 整合 Excel 泡泡版</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* 樣式部分完整保留 n09 原樣，未作變動 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 16px;
            line-height: 1.4;
            position: relative;
        }
        .ai-message {
            align-self: flex-start;
            background-color: #ffffff;
            color: #1c1e21;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .summary-card {
            background: #ffffff;
            border-radius: 20px;
            padding: 20px;
            width: 300px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            color: #333;
        }
        /* ... 其他 n09 原有樣式 ... */
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 18px; font-weight: bold; }
        .card-date { font-size: 14px; color: #888; }
        .battery-container { position: relative; width: 140px; height: 140px; margin: 0 auto 25px; }
        .battery-circle { width: 100%; height: 100%; border-radius: 50%; background: #f0f0f0; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .battery-value { font-size: 36px; font-weight: bold; }
        .battery-label { font-size: 12px; color: #666; }
        .status-light { position: absolute; top: 5px; right: 5px; width: 32px; height: 32px; border-radius: 50%; border: 3px solid #fff; }
        .light-red { background-color: #ff4d4f; }
        .light-yellow { background-color: #ffec3d; }
        .light-green { background-color: #52c41a; }
        .info-section { display: flex; gap: 15px; margin-bottom: 20px; }
        .info-item { flex: 1; padding: 12px; border-radius: 15px; }
        .best-bg { background-color: #f6ffed; }
        .worst-bg { background-color: #fff1f0; }
        .info-label { font-size: 12px; color: #666; margin-bottom: 4px; display: block; }
        .info-text { font-size: 14px; font-weight: bold; }
    </style>
</head>
<body>

<div id="chat-container"></div>

<script>
    // --- 全域變數 ---
    let cachedExcelData = null;

    // --- 新增：核心指標比對與 Excel 抓取函數 ---
    async function getHealthIndicatorComment(todayRaw, prevRaw) {
        try {
            if (!prevRaw) return null;

            let field = "";
            let tag = "";

            // 嚴格比對邏輯
            if (todayRaw.Battery_TST_min_A < prevRaw.Battery_TST_min_A && todayRaw.Battery_TST_min_A > 420) {
                field = "TST_min"; tag = "▼▲";
            } else if (todayRaw.Battery_N3_pct_A < prevRaw.Battery_N3_pct_A) {
                field = "N3_pct"; tag = "▼";
            } else if (todayRaw.Battery_rMSSD_A < prevRaw.Battery_rMSSD_A) {
                field = "rMSSD"; tag = "▼";
            } else if (todayRaw.Battery_HR_min_A < prevRaw.Battery_HR_min_A) {
                field = "HR_min"; tag = "▼";
            } else if (todayRaw.Battery_HBI_A > prevRaw.Battery_HBI_A) {
                field = "HBI"; tag = "▲";
            }

            if (!field) return null;

            // 讀取 phrase.xlsx
            if (!cachedExcelData) {
                const response = await fetch('phrase.xlsx');
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                cachedExcelData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            }

            // 比對 Excel
            const matchRow = cachedExcelData.find(r => 
                String(r["指標名稱"]).trim() === field && 
                String(r["狀態"]).trim() === tag
            );

            if (matchRow) {
                // 優先抓取「重點摘要」，其次是長版本
                return matchRow["重點摘要"] || matchRow["一句大眾易懂又強調健康價值的版本"];
            }
        } catch (e) {
            console.error("Excel Processing Error:", e);
        }
        return null;
    }

    // --- 修改後的 showSummaryFlow ---
    async function showSummaryFlow(nickname, isFirstTimeNaming) {
        const today = new Date().toISOString().split('T')[0];
        
        // 抓取當天與前一天資料
        const { data: healths } = await _supabase.from('health_data')
            .select('record_date, raw_json')
            .eq('serial_number', currentSerial)
            .lte('record_date', today)
            .order('record_date', { ascending: false })
            .limit(2);

        if (!healths || healths.length === 0) return;

        // 原本 fetchSummaryData 的邏輯 (產出卡片所需數據)
        const summaryData = await fetchSummaryData(today); 
        
        // 1. 顯示打招呼
        appendAiMessage(isFirstTimeNaming ? 
            "謝謝你幫我取的名字，我們一起來看看今天的健康摘要吧！ ✨" : 
            `哈囉，${nickname}！我們一起來看看今天的健康摘要吧！ ✨`);

        // 2. 顯示健康卡片 (原有 n09 功能)
        appendSummaryCard(summaryData);

        // 3. 新增：顯示 Excel 指標比對後的對話泡泡
        if (healths.length >= 2) {
            const comment = await getHealthIndicatorComment(healths[0].raw_json, healths[1].raw_json);
            if (comment) {
                setTimeout(() => {
                    appendAiMessage(comment);
                }, 800); // 稍微延遲，體感更自然
            }
        }
    }

    // (其餘 appendAiMessage, appendSummaryCard, fetchSummaryData 函數保持 n09 原樣)
</script>
</body>
</html>
