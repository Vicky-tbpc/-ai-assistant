<script>
    // ... (前段初始化保持不變) ...

    let isNamingPhase = false; // 紀錄是否正在「取名字」的階段

    async function login() {
        const serial = document.getElementById('serial').value;
        const pw = document.getElementById('pw').value;
        const { data } = await _supabase.from('user_credentials').select('*').eq('serial_number', serial).eq('password', pw).single();
        
        if (data) {
            currentSerial = serial;
            document.getElementById('login-overlay').classList.add('hidden');
            if (!data.nickname) {
                document.getElementById('nickname-overlay').classList.remove('hidden');
            } else {
                initApp(data.nickname, data.ai_name); // 傳入 ai_name 判斷
            }
        } else { alert("驗證失敗"); }
    }

    async function saveNickname() {
        const nick = document.getElementById('new-nickname').value;
        if(!nick) return;
        await _supabase.from('user_credentials').update({ nickname: nick }).eq('serial_number', currentSerial);
        document.getElementById('nickname-overlay').classList.add('hidden');
        initApp(nick, null); // 剛寫好暱稱，ai_name 必為空
    }

    function initApp(nickname, aiName) {
        document.getElementById('app-container').classList.remove('hidden');
        document.getElementById('display-name').innerText = nickname;
        document.getElementById('avatar-char').innerText = nickname.charAt(0);
        
        // 隱藏原本的靜態文字
        document.getElementById('welcome-text').classList.add('hidden');

        if (!aiName) {
            // 進入命名階段
            isNamingPhase = true;
            appendAiMessage("很高興認識你，我會即時反映你的健康數據與身體變化，陪伴你一起守護健康。請幫我取一個名字，讓我成為專屬於你的健康夥伴。");
        } else {
            appendAiMessage(`歡迎回來，我是你的健康夥伴 ${aiName}。`);
        }
    }

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if (!text) return;

        // 1. 顯示使用者訊息
        appendUserMessage(text);
        input.value = '';

        if (isNamingPhase) {
            // 2. 處理取名邏輯
            const { error } = await _supabase.from('user_credentials')
                .update({ ai_name: text })
                .eq('serial_number', currentSerial);

            if (!error) {
                isNamingPhase = false;
                setTimeout(() => {
                    appendAiMessage("謝謝你幫我取的名字，我們一起來看看今天的健康摘要吧！");
                }, 800);
            }
        } else {
            // 3. 一般對話 (之後串接 Gemini)
            setTimeout(() => {
                appendAiMessage("正在分析您的健康數據...");
            }, 800);
        }
    }

    function appendUserMessage(msg) {
        document.getElementById('chat-history').innerHTML += `
            <div class="msg-row user-row">
                <div class="user-bubble" style="color: black;">${msg}</div>
            </div>`;
        scrollToBottom();
    }

    function appendAiMessage(msg) {
        document.getElementById('chat-history').innerHTML += `
            <div class="msg-row ai-row">
                <div class="ai-bubble">${msg}</div>
            </div>`;
        scrollToBottom();
    }

    function scrollToBottom() {
        const main = document.getElementById('main-area');
        main.scrollTop = main.scrollHeight;
    }
</script>
