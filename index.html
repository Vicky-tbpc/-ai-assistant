<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soosyn AI 健康助理 15</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --brand-blue: #6c83cf; --text-main: #5a5a5a; --bg-gray: #f8f9fa; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: var(--bg-gray); color: var(--text-main); }
        .summary-pill { background: #f0f0f0; border-radius: 30px; padding: 12px 20px; font-size: 13px; display: flex; align-items: center; }
        .score-display { font-size: 72px; font-weight: 900; line-height: 1; }
        .modal-bg { background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .chat-bubble-ai { background: white; border-radius: 20px 20px 20px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="loginSection" class="fixed inset-0 z-[1000] bg-white flex flex-col items-center justify-center p-6">
        <div class="max-w-xs w-full text-center">
            <h1 class="text-3xl font-bold text-[#6c83cf] mb-8">Soosyn AI</h1>
            <input id="serviceID" type="text" placeholder="服務序號 (如 BA000001)" class="w-full border-2 p-3 rounded-xl mb-4">
            <input id="password" type="password" placeholder="密碼" class="w-full border-2 p-3 rounded-xl mb-4">
            <button onclick="handleLogin()" class="w-full bg-[#6c83cf] text-white py-3 rounded-xl font-bold">登入</button>
            <button onclick="document.getElementById('adminLoginModal').classList.remove('hidden')" class="mt-8 text-xs text-gray-300">管理員登入</button>
        </div>
    </div>

    <div id="mainSection" class="hidden flex flex-col h-screen">
        <header class="p-4 bg-white border-b flex justify-between items-center shadow-sm">
            <span class="font-bold text-[#6c83cf]">Soosyn AI 助理</span>
            <button onclick="openSummaryModal()" class="text-xs bg-blue-50 text-[#6c83cf] px-4 py-2 rounded-full font-bold">查看今日摘要</button>
        </header>
        <main id="chatBox" class="flex-grow overflow-y-auto p-4 space-y-4 bg-[#f8f9fa]"></main>
        <footer class="p-4 bg-white border-t">
            <div class="flex items-center bg-gray-100 rounded-2xl px-4 py-2 max-w-2xl mx-auto">
                <input id="userInput" type="text" placeholder="詢問您的健康狀況..." class="flex-grow bg-transparent outline-none p-2">
                <button onclick="askGemini()" class="text-[#6c83cf] p-2"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </footer>
    </div>

    <div id="summaryModal" class="hidden fixed inset-0 modal-bg z-[500] flex items-center justify-center p-4">
        <div class="bg-white rounded-[2.5rem] max-w-md w-full max-h-[90vh] overflow-y-auto p-8 relative">
            <button onclick="document.getElementById('summaryModal').classList.add('hidden')" class="absolute top-6 right-6 text-2xl text-gray-300">&times;</button>
            
            <div class="flex items-center text-[#5a5a5a] mb-6 space-x-2 relative">
                <i class="fa-solid fa-calendar-days text-[#8699a3]"></i>
                <span id="currDateDisplay" class="font-normal">選擇日期</span>
                <input type="date" id="datePicker" class="absolute inset-0 opacity-0 cursor-pointer" onchange="renderSummary(this.value)">
            </div>

            <div class="text-center mb-6">
                <p class="text-xs font-bold text-[#6c83cf] mb-2">生理電量</p>
                <div id="mainScore" class="score-display">--</div>
                <p id="rankText" class="text-xs text-[#5a5a5a] mt-4 mb-4">正在計算您的生理表現排名...</p>
                <div class="flex items-center justify-center space-x-2 bg-gray-50 py-2 px-4 rounded-full inline-flex">
                    <span id="statusIcon" class="w-3 h-3 rounded-full bg-gray-300"></span>
                    <span id="statusLabel" class="text-xs font-bold text-[#5a5a5a]">讀取中</span>
                </div>
            </div>

            <div class="space-y-3 mb-6">
                <div class="summary-pill"><i class="fa-solid fa-face-smile text-[#a0afb7] mr-3 text-xl"></i><span id="bestText">分析數據中...</span></div>
                <div class="summary-pill"><i class="fa-solid fa-face-frown text-[#ff8c73] mr-3 text-xl"></i><span id="worstText">分析數據中...</span></div>
                <div id="batterySummaryText" class="bg-[#f0f0f0] rounded-2xl p-4 text-xs text-[#5a5a5a] leading-relaxed">建議載入中...</div>
            </div>

            <div class="border-t pt-4 space-y-2 mb-6 text-xs">
                <div class="flex items-start space-x-2"><i class="fa-solid fa-triangle-exclamation text-[#ff8c73] mt-1"></i><p id="attentionText" class="text-[#ff8c73]">正在比對歷史狀態...</p></div>
                <div class="flex items-start space-x-2"><i class="fa-solid fa-circle-info text-[#a79d8c] mt-1"></i><p id="suggestionText" class="text-[#a79d8c]">正在生成健康建議...</p></div>
            </div>

            <div class="bg-blue-50 p-4 rounded-2xl flex items-start space-x-3">
                <div class="flex space-x-0.5 text-[#8699a3] mt-1"><i class="fa-solid fa-flag"></i><i class="fa-solid fa-flag"></i><i class="fa-solid fa-flag"></i></div>
                <p id="goalText" class="text-xs text-[#6c838f]">載入達成目標...</p>
            </div>
        </div>
    </div>

    <div id="adminPanel" class="hidden fixed inset-0 bg-white z-[2000] p-8 overflow-y-auto">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold">Soosyn 管理後台</h2>
                <button onclick="document.getElementById('adminPanel').classList.add('hidden')" class="text-gray-500">關閉</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="border-2 border-dashed p-6 rounded-2xl">
                    <h3 class="font-bold mb-4">1. 上傳健康數據 (Excel)</h3>
                    <input type="file" id="file1" accept=".xlsx, .csv" class="text-xs mb-4">
                    <button onclick="uploadFile1()" class="w-full bg-blue-500 text-white py-2 rounded-lg text-sm">執行同步</button>
                </div>
                <div class="border-2 border-dashed p-6 rounded-2xl">
                    <h3 class="font-bold mb-4">2. 上傳用戶名冊 (Excel)</h3>
                    <input type="file" id="file2" accept=".xlsx, .csv" class="text-xs mb-4">
                    <button onclick="uploadFile2()" class="w-full bg-green-500 text-white py-2 rounded-lg text-sm">更新用戶</button>
                </div>
                <div class="border-2 border-dashed p-6 rounded-2xl">
                    <h3 class="font-bold mb-4">3. 上傳詞句庫 (Excel)</h3>
                    <input type="file" id="file3" accept=".xlsx, .csv" class="text-xs mb-4">
                    <button onclick="uploadFile3()" class="w-full bg-purple-500 text-white py-2 rounded-lg text-sm">載入詞句</button>
                </div>
            </div>
        </div>
    </div>

    <div id="adminLoginModal" class="hidden fixed inset-0 modal-bg z-[1500] flex items-center justify-center">
        <div class="bg-white p-8 rounded-3xl w-80">
            <input id="admPass" type="password" placeholder="管理員密碼" class="w-full border p-4 rounded-xl mb-4">
            <button onclick="checkAdmin()" class="w-full bg-red-500 text-white py-3 rounded-xl font-bold">進入後台</button>
            <button onclick="document.getElementById('adminLoginModal').classList.add('hidden')" class="w-full mt-2 text-gray-400 text-sm">取消</button>
        </div>
    </div>

    <script>
        // --- 核心配置 ---
        const SUPABASE_URL = 'https://gcvwebgfbrsrezxvjafe.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_H_-X-v5cU7I3IHjml2CGUQ_FUK6teZs'; 
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let globalPhraseData = {}; 
        let currentRecords = [];

        // --- 登入邏輯 ---
        async function handleLogin() {
            const sid = document.getElementById('serviceID').value.trim();
            const pwd = document.getElementById('password').value.trim();
            const { data, error } = await _supabase.from('user_profiles').select('*').eq('service_id', sid).single();
            
            if (data && data.password === pwd) {
                currentUser = data;
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainSection').classList.remove('hidden');
                initUserData();
            } else {
                alert("序號或密碼錯誤");
            }
        }

        async function initUserData() {
            const { data } = await _supabase.from('health_records')
                .select('*')
                .eq('service_id', currentUser.service_id)
                .order('record_date', {ascending: false});
            
            currentRecords = data || [];
            if(currentRecords.length > 0) {
                const latestDate = currentRecords[0].record_date;
                renderSummary(latestDate);
            }
        }

        // --- A2-A8 渲染與計算 ---
        async function renderSummary(targetDateStr) {
            const target = currentRecords.find(r => r.record_date.startsWith(targetDateStr));
            if(!target) return;

            document.getElementById('currDateDisplay').innerText = targetDateStr.replace(/-/g, '/');
            const score = Math.round(target.battery_score || 0);
            const scoreEl = document.getElementById('mainScore');
            scoreEl.innerText = score;

            // 顏色與狀態判定
            const colors = { red: "#ff8c73", tan: "#a79d8c", gray: "#a0adb7", navy: "#596b75" };
            scoreEl.style.color = score >= 90 ? colors.navy : score >= 80 ? colors.gray : score >= 60 ? colors.tan : colors.red;
            
            document.getElementById('statusLabel').innerText = currentUser.manual_status || "平衡中";
            const lightMap = { "紅燈": "#ff0000", "黃紅燈": "#ff8000", "黃燈": "#ffe632", "綠燈": "#3caa28" };
            document.getElementById('statusIcon').style.backgroundColor = lightMap[currentUser.manual_status] || "#ccc";

            // 詞句庫比對 (這裡簡化示範，需配合檔案 3)
            if(globalPhraseData.best) {
                // A4-A8 邏輯實作點...
                document.getElementById('bestText').innerText = "今日生理狀態優於昨日表現";
                document.getElementById('goalText').innerText = "連續 3 天達標：睡眠充足！";
            }
        }

// --- 後台上傳邏輯 (強效修正版) ---
        async function uploadFile1() {
            const file = document.getElementById('file1').files[0];
            if (!file) return alert("請先選擇 Excel 檔案");

            const reader = new FileReader();
            reader.onload = async (e) => {
                const wb = XLSX.read(e.target.result, { type: 'array' });
                
                let report = []; // 用來記錄每一張工作表的處理狀況
                let successTotal = 0;

                // 迴圈遍歷所有工作表
                for (const originalName of wb.SheetNames) {
                    // 1. 去除名稱前後空格，並轉大寫以防萬一
                    const sheetName = originalName.trim(); 
                    
                    // 2. 寬鬆判定：只要名稱包含 "BA" 且後面跟著數字，或者使用者強制要求處理
                    // 這裡先維持您的規則：以 BA 開頭 (忽略大小寫)
                    if (!sheetName.toUpperCase().startsWith('BA')) {
                        console.log(`跳過工作表: ${sheetName} (非 BA 開頭)`);
                        continue;
                    }

                    const data = XLSX.utils.sheet_to_json(wb.Sheets[originalName], { defval: "" }); // defval 避免空值造成的 key 遺失
                    
                    if (data.length === 0) {
                        report.push(`❌ ${sheetName}: 空白工作表`);
                        continue;
                    }

                    // 檢查第一筆資料的欄位，用來 debug
                    const firstRow = data[0];
                    // 自動去除欄位名稱的空格 (例如 " record_end " -> "record_end")
                    const cleanData = data.map(row => {
                        const newRow = {};
                        for (let key in row) {
                            newRow[key.trim()] = row[key];
                        }
                        return newRow;
                    });

                    const batch = cleanData.map(r => {
                        // 3. 彈性抓取日期欄位 (優先找 record_end，沒有則找 record_date)
                        let rawDate = r['record_end'] || r['record_date'] || r['Record_End'] || r['Record_Date'];
                        
                        if (!rawDate) return null; // 該行沒有日期，跳過

                        // 嘗試解析日期
                        let dateOnly = null;
                        try {
                            // 處理 Excel 數字日期 (例如 45321)
                            if (typeof rawDate === 'number') {
                                const excelDate = XLSX.SSF.parse_date_code(rawDate);
                                dateOnly = `${excelDate.y}-${String(excelDate.m).padStart(2,'0')}-${String(excelDate.d).padStart(2,'0')}`;
                            } 
                            // 處理字串日期 "2026/2/10 5:31" 或 "2026-02-10"
                            else {
                                const d = new Date(rawDate);
                                if (isNaN(d.getTime())) return null;
                                dateOnly = d.toISOString().split('T')[0];
                            }
                        } catch (err) {
                            return null;
                        }

                        return {
                            service_id: sheetName, // 使用去空格後的名稱
                            record_date: dateOnly,
                            // 4. 彈性抓取分數欄位
                            battery_score: r['Personal_Battery_weighted_round'] || r['Personal_Battery_A_round'] || 0,
                            raw_data: r // 存入完整原始資料
                        };
                    }).filter(item => item !== null);

                    if (batch.length > 0) {
                        // 上傳至 Supabase
                        const { error } = await _supabase.from('health_records').upsert(batch, { 
                            onConflict: 'service_id, record_date' 
                        });

                        if (error) {
                            report.push(`❌ ${sheetName}: 上傳錯誤 (${error.message})`);
                        } else {
                            report.push(`✅ ${sheetName}: 成功 ${batch.length} 筆`);
                            successTotal += batch.length;
                        }
                    } else {
                        report.push(`⚠️ ${sheetName}: 有資料但無有效日期`);
                    }
                }

                // 顯示詳細結果
                if (report.length === 0) {
                    alert("⚠️ 未找到任何以 'BA' 開頭的工作表，請確認 Excel 檔案。");
                } else {
                    alert(`處理完成！總計匯入 ${successTotal} 筆資料。\n\n詳細報告:\n${report.join('\n')}`);
                    // 重新整理前台畫面
                    if (currentUser) initUserData();
                }
            };
            reader.readAsArrayBuffer(file);
        }        


        async function uploadFile2() {
            const file = document.getElementById('file2').files[0];
            const reader = new FileReader();
            reader.onload = async (e) => {
                const wb = XLSX.read(e.target.result, {type:'array'});
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                await _supabase.from('user_profiles').upsert(data.map(r => ({
                    service_id: r.service_id,
                    password: r.password,
                    manual_status: r.manual_status
                })));
                alert("用戶名冊更新完畢");
            };
            reader.readAsArrayBuffer(file);
        }

        async function uploadFile3() {
            const file = document.getElementById('file3').files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const wb = XLSX.read(e.target.result, {type:'array'});
                wb.SheetNames.forEach(n => {
                    globalPhraseData[n.toLowerCase()] = XLSX.utils.sheet_to_json(wb.Sheets[n]);
                });
                alert("詞句庫載入成功");
            };
            reader.readAsArrayBuffer(file);
        }

        // --- Gemini API 功能 (保留原功能不更動) ---
        async function askGemini() {
            const input = document.getElementById('userInput');
            const msg = input.value.trim();
            if(!msg) return;

            appendMessage('user', msg);
            input.value = '';

            const loadingId = 'loading-' + Date.now();
            appendMessage('ai', '思考中...', loadingId);

            try {
                // 這裡模擬您的 API Proxy 呼叫，請確保 URL 正確
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=YOUR_API_KEY', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `用戶健康紀錄: ${JSON.stringify(currentRecords.slice(0,3))}\n問題: ${msg}` }] }]
                    })
                });
                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text;
                
                document.getElementById(loadingId).innerText = aiText;
            } catch (err) {
                document.getElementById(loadingId).innerText = "抱歉，我現在無法連線至 AI 助理。";
            }
        }

        function appendMessage(role, text, id = '') {
            const box = document.getElementById('chatBox');
            const div = document.createElement('div');
            div.id = id;
            div.className = role === 'ai' ? "chat-bubble-ai p-4 text-sm max-w-[85%] leading-relaxed" : 
                            "bg-[#6c83cf] text-white self-end p-4 rounded-2xl rounded-tr-none text-sm max-w-[85%] flex ml-auto shadow-md";
            div.innerText = text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // --- 管理員權限 ---
        function checkAdmin() {
            if(document.getElementById('admPass').value === '888tBPC!!') {
                document.getElementById('adminLoginModal').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
            } else alert("密碼錯誤");
        }

        function openSummaryModal() {
            if(currentRecords.length === 0) return alert("尚無數據");
            document.getElementById('summaryModal').classList.remove('hidden');
        }
    </script>
</body>
</html>
