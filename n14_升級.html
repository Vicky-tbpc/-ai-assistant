<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Soosyn å¥åº·å¤¥ä¼´ n14</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --tbp-blue: #8699a3; --tbp-light-blue: #e6f0f9; --bg-color: #f5f1eb;
            --text-dark: #333; --user-msg-bg: #e2ddd4; --ai-msg-bg: #ffffff;
            --accent-red: #ff8c73; --chart-grey: #c1cdd3; --chart-dot: #596b75;
        }

        body, html { margin: 0; padding: 0; height: 100%; background-color: var(--bg-color); color: var(--text-dark); font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; overflow: hidden; }
        .hidden { display: none !important; }

        /* ä»‹é¢ä½ˆå±€ */
        #app-container { display: flex; flex-direction: column; height: 100vh; }
        header { height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: white; border-bottom: 1px solid #eee; z-index: 100; }
        .logo-text { font-weight: bold; color: var(--tbp-blue); font-size: 1.1rem; }
        .user-info { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .avatar { width: 32px; height: 32px; background: var(--tbp-light-blue); color: var(--tbp-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; }

        main { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; scroll-behavior: smooth; }
        #chat-history { width: 100%; max-width: 800px; display: flex; flex-direction: column; gap: 12px; }

        /* è¨Šæ¯æ°£æ³¡ */
        .msg-row { display: flex; width: 100%; margin: 4px 0; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .user-row { justify-content: flex-end; }
        .user-bubble { background: var(--user-msg-bg); padding: 10px 15px; border-radius: 18px 18px 2px 18px; max-width: 80%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .ai-row { justify-content: flex-start; }
        .ai-bubble { background: var(--ai-msg-bg); padding: 10px 15px; border-radius: 18px 18px 18px 2px; max-width: 80%; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* å¥åº·æ‘˜è¦èˆ‡æŒ‰éˆ• */
        .summary-card { background: #fff; border-radius: 16px; width: 280px; padding: 18px; border-left: 6px solid #ddd; box-shadow: 0 8px 15px rgba(0,0,0,0.05); }
        .battery-val { font-size: 1.8rem; font-weight: bold; }
        .progress-bg { width: 100%; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; transition: width 1s; }
        .quick-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
        .action-btn { background: white; border: 1px solid var(--tbp-blue); color: var(--tbp-blue); padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; }

        /* åœ–è¡¨å½ˆçª— */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 3000; padding: 15px; }
        .chart-modal { background: white; width: 100%; max-width: 600px; border-radius: 20px; padding: 20px; position: relative; max-height: 90vh; overflow-y: auto; }
        .chart-title { color: #5a5a5a; font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; }
        .chart-unit { font-size: 0.8rem; color: #888; margin-bottom: 10px; }
        .chart-tabs { display: flex; gap: 8px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 8px; border-radius: 10px; border: 1px solid #ddd; background: #f9f9f9; cursor: pointer; font-size: 0.8rem; }
        .tab-btn.active { background: var(--tbp-blue); color: white; border-color: var(--tbp-blue); }
        .close-btn { position: absolute; top: 15px; right: 15px; font-size: 1.5rem; cursor: pointer; color: #aaa; }

        /* è¼¸å…¥æ¡† */
        .footer-input { padding: 15px 20px 30px 20px; background: var(--bg-color); display: flex; justify-content: center; }
        .input-box { width: 100%; max-width: 800px; background: white; border-radius: 25px; padding: 5px 15px; display: flex; align-items: center; border: 1px solid #ddd; }
        #user-input { flex: 1; border: none; outline: none; padding: 10px; font-size: 16px; background: transparent; }
        .send-btn { background: var(--tbp-blue); color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .typing-dots { display: flex; gap: 4px; padding: 5px 10px; }
        .dot { width: 6px; height: 6px; background: #ccc; border-radius: 50%; animation: blink 1.4s infinite both; }
        @keyframes blink { 0%, 80%, 100% { opacity: 0.2; } 40% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="login-overlay" class="modal-overlay">
        <div style="background:white; padding:30px; border-radius:15px; text-align:center; width:300px;">
            <h2 style="color:var(--tbp-blue)">Soosyn Health</h2>
            <input type="text" id="serial" placeholder="åºè™Ÿ" value="">
            <input type="password" id="pw" placeholder="å¯†ç¢¼" value="">
            <button class="primary-btn" onclick="login()" style="width:100%; padding:12px; border-radius:8px; border:none; background:var(--tbp-blue); color:white; font-weight:bold; cursor:pointer;">ç™»å…¥</button>
        </div>
    </div>

    <div id="nickname-overlay" class="modal-overlay hidden">
        <div style="background:white; padding:30px; border-radius:15px; text-align:center;">
            <h3>æ­¡è¿ï¼è«‹å•è©²æ€éº¼ç¨±å‘¼ä½ ï¼Ÿ</h3>
            <input type="text" id="new-nickname" placeholder="ä½ çš„æš±ç¨±">
            <button onclick="saveNickname()" style="width:100%; padding:12px; border-radius:8px; border:none; background:var(--tbp-blue); color:white;">é–‹å§‹é«”é©—</button>
        </div>
    </div>

    <div id="chart-modal-overlay" class="modal-overlay hidden">
        <div class="chart-modal">
            <span class="close-btn" onclick="closeChart()">Ã—</span>
            <div id="chart-title" class="chart-title"></div>
            <div id="chart-unit" class="chart-unit"></div>
            <div class="chart-tabs">
                <button class="tab-btn active" onclick="updateChartDays(7, this)">7æ—¥è¶¨å‹¢</button>
                <button class="tab-btn" onclick="updateChartDays(14, this)">14æ—¥è¶¨å‹¢</button>
                <button class="tab-btn" onclick="updateChartDays(30, this)">30æ—¥è¶¨å‹¢</button>
            </div>
            <div style="height: 300px; position: relative;">
                <canvas id="healthChart"></canvas>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <header>
            <div class="logo-text">Health Companion</div>
            <div class="user-info" onclick="toggleDropdown()">
                <div id="display-name" style="font-size: 14px; color: #666;">User</div>
                <div class="avatar" id="avatar-char">U</div>
            </div>
            <div id="settings-menu" class="dropdown hidden" style="position: absolute; top: 60px; right: 20px; background:white; box-shadow:0 4px 10px rgba(0,0,0,0.1); border-radius:8px; z-index:500;">
                <button onclick="logout()" style="padding:10px 20px; border:none; background:none; cursor:pointer; color:var(--accent-red)">ç™»å‡º</button>
            </div>
        </header>

        <main id="main-area"><div id="chat-history"></div></main>

        <div class="footer-input">
            <div class="input-box">
                <input type="text" id="user-input" placeholder="å•å•æˆ‘é—œæ–¼å¥åº·è³‡è¨Šæˆ–è¶¨å‹¢åœ–..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button class="send-btn" onclick="sendMessage()">â–²</button>
            </div>
        </div>
    </div>

<script>
    const SUPABASE_URL = "https://gcvwebgfbrsrezxvjafe.supabase.co";
    const SUPABASE_KEY = "sb_publishable_H_-X-v5cU7I3IHjml2CGUQ_FUK6teZs";
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentSerial = "", myNickname = "", myAiName = "";
    let healthDataRaw = []; 
    let activeChartType = "";
    let chartInstance = null;

    const RANDOM_PHRASES = [
        "ä¿æŒå¥åº·æ˜¯æ¯å¤©çš„å°ç´¯ç©ï¼Œé‚„æƒ³å…ˆäº†è§£å“ªå€‹å¥åº·è³‡è¨Šå‘¢ï¼Ÿè¶¨å‹¢åœ–è¡¨ã€ç”Ÿç†é›»é‡ã€rMSSDæ”¾é¬†æ¢å¾©ï¼Œé‚„æ˜¯ç¡çœ æœ€ä½è„ˆæï¼Ÿ",
        "å¥åº·éƒ½æ˜¯ä¸€é»ä¸€æ»´ç´¯ç©çš„ğŸŒ¿ï¼Œé‚„æƒ³äº†è§£å“ªå€‹æŒ‡æ¨™å‘¢ï¼Ÿè¶¨å‹¢åœ–è¡¨ã€ç”Ÿç†ç‹€æ…‹ã€N3æ·±ç¡æ¯”ä¾‹æˆ–HBIç¼ºæ°§è² è·å‘¢ï¼Ÿ",
        "ç¶­æŒå¥åº·çš„å¥½ç¿’æ…£å¾ˆé‡è¦ï¼é‚„æƒ³æŸ¥çœ‹å“ªå€‹è³‡è¨Šå‘¢ï¼Ÿç”Ÿç†é›»é‡ã€è¶¨å‹¢åœ–ã€rMSSDæ”¾é¬†æ¢å¾© æˆ–ç¡çœ æœ€ä½è„ˆæï¼Ÿ"
    ];

    async function login() {
        const serial = document.getElementById('serial').value, pw = document.getElementById('pw').value;
        const { data } = await _supabase.from('user_credentials').select('*').eq('serial_number', serial).eq('password', pw).single();
        if (data) {
            currentSerial = serial; myNickname = data.nickname; myAiName = data.ai_name;
            document.getElementById('login-overlay').classList.add('hidden');
            if (!myNickname) document.getElementById('nickname-overlay').classList.remove('hidden');
            else initApp();
        } else alert("é©—è­‰å¤±æ•— ğŸ˜…");
    }

    async function initApp() {
        document.getElementById('app-container').classList.remove('hidden');
        document.getElementById('display-name').innerText = myNickname;
        document.getElementById('avatar-char').innerText = myNickname.charAt(0);

        const todayStr = new Date().toISOString().split('T')[0];
        const lastLogin = localStorage.getItem(`last_login_${currentSerial}`);
        
        // æŠ“å–æœ€è¿‘ 30 å¤©æ•¸æ“šå‚™ç”¨
        const { data } = await _supabase.from('health_data').select('*').eq('serial_number', currentSerial).order('record_date', {ascending: false}).limit(30);
        healthDataRaw = data || [];

        if (lastLogin !== todayStr) {
            // ç•¶å¤©ç¬¬ä¸€æ¬¡ç™»å…¥
            localStorage.setItem(`last_login_${currentSerial}`, todayStr);
            await showInitialFlow();
        } else {
            // ç•¶å¤©ç¬¬äºŒæ¬¡åŠä»¥å¾Œ
            await appendAiMessage(`æ­¡è¿å›ä¾† ${myNickname}ï¼Œæˆ‘æ˜¯ä½ çš„å¥åº·å¤¥ä¼´ ${myAiName || 'vv'}ã€‚ ğŸ‘‹`);
            await appendAiMessage(getRandomPhrase());
        }
    }

    async function showInitialFlow() {
        // 1. é¡¯ç¤ºç•¶å¤©æ‘˜è¦
        const todayData = await fetchSummaryData(new Date().toISOString().split('T')[0]);
        if (todayData) appendSummaryCard(todayData);

        // 2. é€²è¡Œé€£çºŒå¤©æ•¸æª¢æŸ¥ (Logic Keys)
        await checkConsecutiveTrends();

        // 3. çµå°¾éš¨æ©Ÿèªå¥
        await appendAiMessage(getRandomPhrase());
    }

    async function checkConsecutiveTrends() {
        if (healthDataRaw.length < 3) return;
        const latest = healthDataRaw.map(d => d.raw_json);
        const avg7 = calculateAvg(latest, 7);
        
        const conditions = [
            { key: "5ds TST_min<420", check: () => latest.slice(0,5).every(d => d.Battery_TST_min_A < 420), len: 5 },
            { key: "3ds TST_min<420", check: () => latest.slice(0,3).every(d => d.Battery_TST_min_A < 420), len: 3 },
            { key: "5ds N3_pct<avg", check: () => latest.slice(0,5).every(d => d.Battery_N3_pct_A < avg7.N3), len: 5 },
            { key: "3ds N3_pct<avg", check: () => latest.slice(0,3).every(d => d.Battery_N3_pct_A < avg7.N3), len: 3 },
            { key: "3ds rMSSD<avg", check: () => latest.slice(0,3).every(d => d.Battery_rMSSD_A < avg7.rMSSD * 0.9), len: 3 },
            { key: "3ds HR_min>avg", check: () => latest.slice(0,3).every(d => d.Battery_HR_min_A > avg7.HR + 5), len: 3 },
            { key: "3ds HBI>avg", check: () => latest.slice(0,3).every(d => d.Battery_HBI_A > avg7.HBI), len: 3 },
            { key: "3ds TST_min>420", check: () => latest.slice(0,3).every(d => d.Battery_TST_min_A > 420), len: 3 },
            { key: "3ds N3_pct>avg", check: () => latest.slice(0,3).every(d => d.Battery_N3_pct_A > avg7.N3), len: 3 },
            { key: "3ds rMSSD>avg", check: () => latest.slice(0,3).every(d => d.Battery_rMSSD_A > avg7.rMSSD * 1.1), len: 3 },
            { key: "3ds HR_min<avg", check: () => latest.slice(0,3).every(d => d.Battery_HR_min_A < avg7.HR - 5), len: 3 },
            { key: "3ds HBI<avg", check: () => latest.slice(0,3).every(d => d.Battery_HBI_A < avg7.HBI), len: 3 },
            { key: "3ds battery>avg", check: () => latest.slice(0,3).every(d => d.Personal_Battery_weighted_round > avg7.Battery), len: 3 }
        ];

        for (let cond of conditions) {
            if (healthDataRaw.length >= cond.len && cond.check()) {
                const { data } = await _supabase.from('phrase_library').select('detailed_content').eq('logic_key', cond.key).single();
                if (data) await appendAiMessage(data.detailed_content);
                break; // å„ªå…ˆå‘ˆç¾ç¬¬ä¸€å€‹ç¬¦åˆçš„ï¼ˆä¾‹å¦‚ 5å¤©å„ªå…ˆæ–¼ 3å¤©ï¼‰
            }
        }
    }

    function calculateAvg(data, days) {
        const slice = data.slice(0, days);
        const sum = (key) => slice.reduce((acc, curr) => acc + (curr[key] || 0), 0) / slice.length;
        return {
            N3: sum('Battery_N3_pct_A'), rMSSD: sum('Battery_rMSSD_A'), 
            HR: sum('Battery_HR_min_A'), HBI: sum('Battery_HBI_A'), 
            Battery: sum('Personal_Battery_weighted_round')
        };
    }

    async function sendMessage() {
        const input = document.getElementById('user-input'), msg = input.value.trim();
        if (!msg) return; input.value = ''; appendUserMessage(msg);

        // è¶¨å‹¢åœ–é—œéµå­—
        if (msg.includes("è¶¨å‹¢åœ–")) {
            await appendAiMessage("è«‹å•ä½ éœ€è¦çœ‹å“ªä¸€ç¨®è¶¨å‹¢åœ–è¡¨å‘¢ï¼Ÿ");
            appendQuickActions(["å®Œæ•´è¶¨å‹¢åœ–è¡¨", "ç”Ÿç†é›»é‡è¶¨å‹¢åœ–è¡¨", "N3æ·±ç¡æ¯”ä¾‹è¶¨å‹¢åœ–è¡¨", "rMSSDæ”¾é¬†æ¢å¾©è¶¨å‹¢åœ–è¡¨", "ç¡çœ æœ€ä½è„ˆæè¶¨å‹¢åœ–è¡¨", "HBIç¼ºæ°§è² è·è¶¨å‹¢åœ–è¡¨"]);
            return;
        }

        // ç™¾ç§‘é—œéµå­—æŸ¥è©¢
        const keywords = ["ç”Ÿç†é›»é‡", "ç”Ÿç†ç‹€æ…‹", "ç¸½ç¡çœ æ™‚é–“", "N3æ·±ç¡æ¯”ä¾‹", "rMSSDæ”¾é¬†æ¢å¾©", "ç¡çœ æœ€ä½è„ˆæ", "HBIç¼ºæ°§è² è·", "REMå¿«é€Ÿå‹•çœ¼æœŸ"];
        const foundKey = keywords.find(k => msg.includes(k));
        if (foundKey) {
            const { data } = await _supabase.from('phrase_library').select('detailed_content').eq('title', foundKey).single();
            if (data) await appendAiMessage(data.detailed_content);
            return;
        }

        // åœ–è¡¨è§¸ç™¼
        if (msg.includes("è¶¨å‹¢åœ–è¡¨")) {
            if (msg.includes("å®Œæ•´")) openChartModal("FULL");
            else if (msg.includes("ç”Ÿç†é›»é‡")) openChartModal("BATTERY");
            else if (msg.includes("N3")) openChartModal("N3");
            else if (msg.includes("rMSSD")) openChartModal("RMSSD");
            else if (msg.includes("ç¡çœ æœ€ä½è„ˆæ")) openChartModal("HR");
            else if (msg.includes("HBI")) openChartModal("HBI");
            return;
        }

        await appendAiMessage("æ”¶åˆ°ï¼æˆ‘æ­£åœ¨æŒçºŒå­¸ç¿’å¦‚ä½•åˆ†æé€™äº›æ•¸æ“šï¼Œå¸Œæœ›èƒ½å¸¶çµ¦ä½ æ›´å¥½çš„å¥åº·å»ºè­°ã€‚ âœ¨");
    }

    /* --- åœ–è¡¨æ ¸å¿ƒé‚è¼¯ --- */
    function openChartModal(type) {
        activeChartType = type;
        document.getElementById('chart-modal-overlay').classList.remove('hidden');
        renderHealthChart(7);
    }

    function closeChart() {
        document.getElementById('chart-modal-overlay').classList.add('hidden');
        if (chartInstance) chartInstance.destroy();
    }

    function updateChartDays(days, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderHealthChart(days);
    }

    function renderHealthChart(days) {
        const ctx = document.getElementById('healthChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        const dataSlice = [...healthDataRaw].reverse().slice(-days);
        const labels = dataSlice.map(d => d.record_date.split('-').slice(1).join('/'));
        
        let chartConfig = getChartConfig(activeChartType, dataSlice, labels);
        
        document.getElementById('chart-title').innerText = chartConfig.title;
        document.getElementById('chart-unit').innerText = chartConfig.unit ? `å–®ä½ï¼š${chartConfig.unit}` : "";
        
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: chartConfig.datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } } },
                scales: { y: { beginAtZero: false, grid: { color: '#f0f0f0' } }, x: { grid: { display: false } } }
            }
        });
    }

    function getChartConfig(type, data, labels) {
        const rawValues = (key) => data.map(d => d.raw_json[key] || 0);
        const sma7 = (vals) => vals.map((_, i, arr) => {
            const sub = arr.slice(Math.max(0, i - 6), i + 1);
            return Math.round(sub.reduce((a, b) => a + b, 0) / sub.length);
        });

        const commonLine = (vals, avg, threshold = null, compareType = 'low') => ({
            type: 'line', label: 'ç•¶æ—¥æ•¸å€¼', data: vals, borderColor: '#999', borderWidth: 2,
            pointBackgroundColor: vals.map((v, i) => {
                const comp = threshold !== null ? threshold : avg[i];
                if (compareType === 'low') return v < comp ? '#ff8c73' : '#596b75';
                return v > comp ? '#ff8c73' : '#596b75';
            }),
            pointRadius: 4, fill: false, order: 1
        });

        const commonBar = (label, data) => ({
            type: 'bar', label: label, data: data, backgroundColor: '#c1cdd3', barThickness: 15, order: 2
        });

        // æ ¹æ“šä¸åŒåœ–è¡¨é¡å‹å›å‚³é…ç½®
        switch(type) {
            case "BATTERY":
                const bVals = rawValues('Personal_Battery_weighted_round');
                const bAvg = sma7(bVals);
                return { title: "ç”Ÿç†é›»é‡è¶¨å‹¢", unit: "", datasets: [commonLine(bVals, bAvg), commonBar('7æ—¥å‡å€¼', bAvg)] };
            case "N3":
                const n3Vals = rawValues('Battery_N3_pct_A');
                const n3Avg = sma7(n3Vals);
                return { title: "N3 æ·±ç¡æ¯”ä¾‹è¶¨å‹¢", unit: "%", datasets: [commonLine(n3Vals, n3Avg, 10, 'low'), commonBar('7æ—¥å‡å€¼', n3Avg)] };
            case "RMSSD":
                const rVals = rawValues('Battery_rMSSD_A');
                const rAvg = sma7(rVals);
                return { title: "rMSSD æ”¾é¬†æ¢å¾©è¶¨å‹¢", unit: "ms", datasets: [commonLine(rVals, rAvg.map(v => v * 0.9), null, 'low'), commonBar('7æ—¥å‡å€¼ç¯„åœ', rAvg)] };
            case "HR":
                const hVals = rawValues('Battery_HR_min_A');
                const hAvg = sma7(hVals);
                return { title: "ç¡çœ æœ€ä½è„ˆæè¶¨å‹¢", unit: "bpm", datasets: [commonLine(hVals, hAvg.map(v => v + 5), null, 'high'), commonBar('7æ—¥å‡å€¼ç¯„åœ', hAvg)] };
            case "HBI":
                const hbVals = rawValues('Battery_HBI_A');
                const hbAvg = sma7(hbVals);
                return { title: "HBI ç¼ºæ°§è² è·è¶¨å‹¢", unit: "%min/h", datasets: [commonLine(hbVals, hbAvg, null, 'high'), commonBar('7æ—¥å‡å€¼', hbAvg)] };
            default:
                return { title: "è¶¨å‹¢åœ–è¡¨", datasets: [] };
        }
    }

    /* è¼”åŠ©å‡½å¼ */
    function getRandomPhrase() { return RANDOM_PHRASES[Math.floor(Math.random() * RANDOM_PHRASES.length)]; }
    function appendQuickActions(btns) {
        const history = document.getElementById('chat-history');
        let html = '<div class="msg-row ai-row"><div class="quick-actions">';
        btns.forEach(b => html += `<button class="action-btn" onclick="handleQuickAction('${b}')">${b}</button>`);
        history.innerHTML += html + '</div></div>';
        scrollToBottom();
    }
    function handleQuickAction(text) { appendUserMessage(text); document.getElementById('user-input').value = text; sendMessage(); }
    async function appendAiMessage(text) {
        const history = document.getElementById('chat-history'), tid = 't-'+Date.now();
        history.innerHTML += `<div class="msg-row ai-row" id="${tid}"><div class="ai-bubble"><div class="typing-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div></div>`;
        scrollToBottom();
        await new Promise(r => setTimeout(r, 600));
        document.getElementById(tid).querySelector('.ai-bubble').innerHTML = text.replace(/\n/g, '<br>');
        scrollToBottom();
    }
    function appendUserMessage(m) { document.getElementById('chat-history').innerHTML += `<div class="msg-row user-row"><div class="user-bubble">${m}</div></div>`; scrollToBottom(); }
    function scrollToBottom() { const m = document.getElementById('main-area'); m.scrollTop = m.scrollHeight; }
    function toggleDropdown() { document.getElementById('settings-menu').classList.toggle('hidden'); }
    function logout() { localStorage.clear(); location.reload(); }

    async function fetchSummaryData(targetDate) {
        const { data } = await _supabase.from('health_data').select('*').eq('serial_number', currentSerial).lte('record_date', targetDate).order('record_date', { ascending: false }).limit(1);
        if (!data || data.length === 0) return null;
        const raw = data[0].raw_json;
        return { date: data[0].record_date, battery: raw.Personal_Battery_weighted_round, light: 'ç¶ ç‡ˆ' }; // ç°¡åŒ–ç¤ºç¯„
    }

    function appendSummaryCard(data) {
        const cardHtml = `<div class="msg-row ai-row"><div class="summary-card"><strong>ğŸ“… ${data.date} æ‘˜è¦</strong><div class="battery-val">${data.battery}</div><div class="progress-bg"><div class="progress-fill" style="width:${data.battery}%; background:var(--tbp-blue)"></div></div></div></div>`;
        document.getElementById('chat-history').innerHTML += cardHtml;
    }
</script>
</body>
</html>